<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shepherd Meeting Analytics</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<style>
  :root{--bg:#5f61d0;--panel:#f4f5f9;--ink:#2b2f42;--ink-2:#5b6275;--ok:#36c692;--warn:#f5b74d;--bad:#f07474;--chip:#e9efff;--chip-ink:#3a60d8;--muted:#a6aec7}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#6769dd,#5758c8);color:var(--ink);padding:20px}
  .wrap{max-width:1200px;margin:0 auto}
  .card{background:var(--panel);border-radius:18px;box-shadow:0 4px 14px rgba(0,0,0,.12);padding:18px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .h{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{font-size:28px;margin:0}
  .badge{background:#eaf2ff;color:#2544c3;border-radius:999px;padding:6px 10px;font-weight:600;font-size:12px}
  .kpi{display:flex;flex-direction:column;gap:8px}
  .kpi .v{font-size:32px;font-weight:700}
  .muted{color:var(--muted);font-size:12px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:12px 10px;border-bottom:1px solid #e7e9f2;font-size:14px}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px}
  .chip.ok{background:#eafaf3;color:#0b7a51}
  .chip.bad{background:#ffecee;color:#a62828}
  .chip.info{background:#e9efff;color:#2a4cd4}
  button.tag{border:1px solid #f0a15a;color:#a45200;background:#fff5e8;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:700}
  button.tag[disabled]{opacity:.5;cursor:default}

  /* ---- Fixed-height chart boxes to prevent infinite growth ---- */
  .chartBox{height:320px; position:relative;}
  .chartBox canvas{position:absolute; inset:0; width:100% !important; height:100% !important;}
</style>
</head>
<body>
<div class="wrap">
  <div class="card h" style="margin-bottom:16px">
    <h1>Shepherd Meeting Analytics</h1>
    <div>
      <span class="badge" id="rangeTag">Last 90 days</span>
      <span class="badge" id="loadedTag">Loaded (0)</span>
    </div>
  </div>

  <div class="row">
    <div class="card kpi" style="grid-column:span 3">
      <div>Total meetings</div>
      <div class="v" id="kpiTotal">—</div>
      <div class="muted">Zoom lookups: <span id="zoomStats">0/0</span></div>
    </div>
    <div class="card kpi" style="grid-column:span 3">
      <div>Meeting hours</div>
      <div class="v" id="kpiHours">0.0</div>
      <div class="muted">Zoom duration is used when available</div>
    </div>
    <div class="card kpi" style="grid-column:span 3">
      <div>Avg duration (min)</div>
      <div class="v" id="kpiAvg">0</div>
    </div>
    <div class="card kpi" style="grid-column:span 3">
      <div>No-show rate</div>
      <div class="v" id="kpiNoShow">0%</div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card" style="grid-column:span 7">
      <div style="margin-bottom:8px;font-weight:700">Meetings Over Time</div>
      <div class="chartBox"><canvas id="line"></canvas></div>
    </div>
    <div class="card" style="grid-column:span 5">
      <div style="margin-bottom:8px;font-weight:700">Meeting Topics Breakdown</div>
      <div class="chartBox"><canvas id="donut"></canvas></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="h">
      <div style="font-weight:700">Recent Meetings</div>
      <div class="muted">Zoom duration is used when available</div>
    </div>
    <div class="muted">Zoom lookups: <span id="zoomStats2">0/0</span></div>
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Start</th><th>Attendee</th><th>Email</th><th>Topic</th><th>Status</th><th>Zoom Minutes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwAyfs5l36UycQTeaOOjrYxVU_Y_ZoHGNNk1V5OHP5TTo6kpT5qstk4rHeqQFEnv8lZ2A/exec';
const RANGE_DAYS = 90;

let ITEMS = [];
let zoomHits = 0, zoomTotal = 0;

function jjsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = 'gas_cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const t = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, 15000);
    function cleanup(){ clearTimeout(t); s.remove(); delete window[cb]; }
    window[cb]= (data)=>{ cleanup(); resolve(data); };
    s.src = url + (url.includes('?')?'&':'?') + 'jsonp=' + cb;
    s.onerror = ()=>{ cleanup(); reject(new Error('JSONP failed')); };
    document.body.appendChild(s);
  });
}

function normZoomKey(s){
  // normalize "Zoom URL https://..." or "Zoom URL: https://..."
  return String(s||'').replace(/^zoom url[:\s]*/i,'').trim();
}
function fmtMins(n){ return n>0 ? (n+'m') : '—'; }

// --- Rendering
function renderKPIs(){
  const total = ITEMS.length;
  document.getElementById('kpiTotal').textContent = total;
  document.getElementById('loadedTag').textContent = `Loaded (${total})`;

  const mins = ITEMS.map(x => x.zoom_minutes>0?x.zoom_minutes:0);
  const sum  = mins.reduce((a,b)=>a+b,0);
  const hours = (sum/60).toFixed(1);
  const avg = total ? Math.round(sum/total) : 0;
  document.getElementById('kpiHours').textContent = hours;
  document.getElementById('kpiAvg').textContent = avg;

  const noShows = ITEMS.filter(x => (String(x.status).toLowerCase()==='no-show')).length;
  const rate = total? Math.round(noShows*100/total) : 0;
  document.getElementById('kpiNoShow').textContent = rate + '%';

  const zs = `${zoomHits}/${zoomTotal}`;
  document.getElementById('zoomStats').textContent = zs;
  document.getElementById('zoomStats2').textContent = zs;
}

function renderTable(){
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  ITEMS.forEach((x)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(x.start_time).toLocaleString()}</td>
      <td>${x.attendee_name||''}</td>
      <td>${x.attendee_email||''}</td>
      <td>${x.topic||'—'}</td>
      <td>${badge(x.status)}</td>
      <td data-uuid="${x.event_uuid}" class="zoommins">${fmtMins(x.zoom_minutes||0)}</td>
      <td>${actionCell(x)}</td>
    `;
    tb.appendChild(tr);
  });
}
function badge(st){
  const s = String(st||'Scheduled');
  if (s==='Completed') return `<span class="chip ok">Completed</span>`;
  if (s==='Canceled' || s==='Cancelled') return `<span class="chip bad">Canceled</span>`;
  if (s==='No-Show') return `<span class="chip bad">No-Show</span>`;
  return `<span class="chip info">Scheduled</span>`;
}
function actionCell(x){
  const dis = (String(x.status).toLowerCase()==='no-show') ? 'disabled' : '';
  return `<button class="tag" ${dis} data-action="noshow" data-uuid="${x.event_uuid}">Mark No-Show</button>`;
}

let lineChart, donutChart;
function renderCharts(){
  const ctxL = document.getElementById('line').getContext('2d');
  const byDay = {};
  ITEMS.forEach(x=>{
    const d = new Date(x.start_time);
    const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    byDay[key] = (byDay[key]||0) + 1;
  });
  const labels = Object.keys(byDay).sort();
  const data = labels.map(k=>byDay[k]);

  if (lineChart) lineChart.destroy();
  lineChart = new Chart(ctxL,{
    type:'line',
    data:{labels,datasets:[{label:'Completed',data,pointRadius:2}]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      aspectRatio:2.4,     // keep height stable inside .chartBox
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true}}
    }
  });

  const byTopic = {};
  ITEMS.forEach(x=>{
    const t = x.topic && x.topic.trim() ? x.topic.trim() : 'Unspecified';
    byTopic[t] = (byTopic[t]||0)+1;
  });
  const tLabels = Object.keys(byTopic);
  const tData   = tLabels.map(k=>byTopic[k]);
  if (donutChart) donutChart.destroy();
  donutChart = new Chart(document.getElementById('donut').getContext('2d'),{
    type:'doughnut',
    data:{labels:tLabels,datasets:[{data:tData}]},
    options:{responsive:true,maintainAspectRatio:true,cutout:'65%'}
  });
}

async function load(){
  // 1) Fetch rows
  const f = await jjsonp(`${GAS_URL}?action=fetch&rangeDays=${RANGE_DAYS}`);
  if (f.error){ console.error(f.error); return; }
  ITEMS = f.items || [];
  renderKPIs(); renderTable(); renderCharts();

  // 2) Normalize Zoom URLs and enrich
  const urlsRaw = ITEMS.map(x=>x.zoom_url).filter(Boolean);
  const urls = urlsRaw.map(normZoomKey).filter(u=>/zoom\.us\/j\/\d+/.test(u));
  zoomTotal = urls.length;
  renderKPIs();
  if (!urls.length) return;

  // Chunk for URL size
  const CHUNK = 25;
  let merged = {};
  for (let i=0;i<urls.length;i+=CHUNK){
    const part = urls.slice(i,i+CHUNK).map(encodeURIComponent).join(',');
    try{
      const res = await jjsonp(`${GAS_URL}?action=zoomBatch&urls=${part}`);
      if (res && res.map){ Object.assign(merged, res.map); zoomHits += (res.hits||0); renderKPIs(); }
    }catch(e){ console.warn('zoomBatch failed', e); }
  }

  // 3) Apply minutes to UI + persist back
  const writeMap = {};
  ITEMS.forEach(x=>{
    const key = normZoomKey(x.zoom_url);
    const m = merged[key];
    if (typeof m === 'number' && m > 0){
      x.zoom_minutes = m;
      x.status = (String(x.status).toLowerCase()==='no-show')? 'No-Show' : 'Completed';
      writeMap[x.event_uuid] = m;
      const cell = document.querySelector(`td.zoommins[data-uuid="${x.event_uuid}"]`);
      if (cell) cell.textContent = fmtMins(m);
    }
  });
  renderKPIs();

  if (Object.keys(writeMap).length){
    jjsonp(`${GAS_URL}?action=writeZoomMinutes&map=${encodeURIComponent(JSON.stringify(writeMap))}`)
      .catch(()=>{ /* ignore */ });
  }
}

document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-action="noshow"]');
  if (!btn) return;
  const uuid = btn.getAttribute('data-uuid');
  btn.disabled = true; btn.textContent = 'Marking…';
  try{
    const r = await jjsonp(`${GAS_URL}?action=markNoShow&uuid=${encodeURIComponent(uuid)}`);
    if (r && r.ok){
      const row = ITEMS.find(x=>x.event_uuid===uuid);
      if (row){ row.status = 'No-Show'; }
      renderKPIs();
      renderTable();
    } else {
      btn.disabled=false; btn.textContent='Mark No-Show';
      alert('Could not mark no-show.');
    }
  }catch(err){
    btn.disabled=false; btn.textContent='Mark No-Show';
    alert('Error marking no-show.');
  }
});

load();
</script>
</body>
</html>
