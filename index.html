<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shepherd Meeting Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg1:#6b6edc; --bg2:#7c6dd1;
      --card:#f6f7fb; --ink:#334155;
      --muted:#7b87a1; --green:#10b981; --red:#ef4444;
      --pill:#e8f3ff; --pill-ink:#1e293b;
      --ring:rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1400px 700px at 20% -10%, var(--bg1), transparent) ,
                  radial-gradient(1200px 600px at 120% 0%, var(--bg2), transparent) ,
                  linear-gradient(180deg, #6b6edc, #775fc7);
      min-height:100vh; color:var(--ink);
    }
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .header{
      background:rgba(255,255,255,.92); backdrop-filter: blur(8px);
      border-radius:16px; padding:18px 20px; box-shadow:0 8px 24px var(--ring);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{font-size:22px;font-weight:800;display:flex;align-items:center;gap:10px}
    .title .logo{width:22px;height:22px;border-radius:4px;background:conic-gradient(#22c55e, #3b82f6, #a855f7)}
    .sub{font-size:13px;color:var(--muted);display:flex;gap:10px;align-items:center}
    .pill{background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 10px;font-weight:600}
    .grid{display:grid;gap:16px}
    .grid.stats{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{
      background:rgba(255,255,255,.92); backdrop-filter: blur(8px);
      border-radius:16px; padding:16px; box-shadow:0 8px 24px var(--ring);
    }
    .stat .lab{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    .stat .val{font-size:28px;font-weight:800;margin-top:8px}
    .chart-wrap{height:320px; /* crucial: bounds the canvas height */ }
    .chart-wrap canvas{width:100% !important; height:100% !important;}
    .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .legend .dot{width:10px;height:10px;border-radius:2px;margin-right:6px;display:inline-block}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid #e7e9f3;font-size:14px}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;background:#f3f5fb}
    .status{display:inline-flex;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .scheduled{background:#e8f3ff;color:#1e40af}
    .completed{background:#e7f8ef;color:#065f46}
    .canceled{background:#fde8e8;color:#7f1d1d}
    .noshow{background:#fff2cc;color:#7c2d12}
    .btn{border:1px solid #d8dbe8;border-radius:999px;background:white;padding:6px 10px;font-weight:600;cursor:pointer}
    .btn:hover{background:#f6f7fb}
    .note{font-size:13px;color:var(--muted)}
    @media (max-width:1024px){.grid.stats{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.stats{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">
        <div class="logo"></div>
        Shepherd Meeting Analytics
      </div>
      <div class="sub">
        <span class="pill" id="rangePill">Last 365 days</span>
        <span id="loadState" class="pill" style="background:#ecfeff;color:#155e75">Loading…</span>
      </div>
    </div>

    <div class="grid stats" style="margin-top:16px">
      <div class="card stat">
        <div class="lab">Total Meetings</div>
        <div class="val" id="totalMeetings">—</div>
        <div class="note">Zoom lookups: <span id="zoomCount">0</span>/<span id="zoomTotal">0</span></div>
      </div>
      <div class="card stat">
        <div class="lab">Meeting Hours (Actual)</div>
        <div class="val"><span id="actualHours">0.0</span></div>
        <div class="note">Uses Zoom when available</div>
      </div>
      <div class="card stat">
        <div class="lab">Avg Duration (min)</div>
        <div class="val" id="avgMin">0</div>
      </div>
      <div class="card stat">
        <div class="lab">No-Show Rate</div>
        <div class="val" id="noShowRate">0%</div>
      </div>
    </div>

    <div class="grid" style="grid-template-columns: 1.2fr .8fr; margin-top:16px">
      <div class="card">
        <div class="lab" style="margin-bottom:8px">Meetings Over Time</div>
        <div class="chart-wrap"><canvas id="line"></canvas></div>
      </div>
      <div class="card">
        <div class="lab" style="margin-bottom:8px">Meeting Topics Breakdown</div>
        <div class="chart-wrap"><canvas id="topics"></canvas></div>
        <div class="legend" id="topicLegend"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="lab">Recent Meetings</div>
        <div class="note">Zoom duration is used when available</div>
      </div>
      <div class="note" id="zoomProgress" style="margin-bottom:8px">Zoom lookups: 0/0</div>
      <div class="table">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Time</th><th>Attendee</th><th>Email</th><th>Topic</th>
              <th>Status</th><th>Sched (min)</th><th>Zoom (min)</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // =======================
    // CONFIG
    // =======================
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxXQkJJaRF8RLPB_ztL_H9AY6VwM-L7f37qub_2rejnIbrOTMhtUeDxgp4440UTFhGV9A/exec'; // <-- paste your Apps Script Web App URL
    const RANGE_DAYS = 90;

    // Topic color palette (stable mapping)
    const TOPIC_COLORS = {
      "Invoices":"#3b82f6", "Forms":"#f43f5e", "Other":"#fb923c", "Reporting":"#f59e0b",
      "Inventory":"#34d399", "Messaging/Client Communications":"#8b5cf6", "SOAP":"#cbd5e1",
      "Products":"#2563eb", "Reminders":"#ef4444", "Scheduling":"#fb923c",
      "Clients/Patients":"#f59e0b", "Unspecified":"#6366f1"
    };

    // =======================
    // JSONP helper (Apps Script friendly)
    // =======================
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (payload)=>{ delete window[cb]; s.remove(); resolve(payload); };
        const s = document.createElement('script');
        s.src = url + (url.includes('?')?'&':'?') + 'jsonp=' + cb;
        s.onerror = ()=>{ delete window[cb]; s.remove(); reject(new Error('JSONP failed')); };
        document.head.appendChild(s);
      });
    }

    // =======================
    // Utilities
    // =======================
    const fmtDate = d => d.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric'});
    const fmtTime = d => d.toLocaleTimeString(undefined, { hour:'numeric', minute:'2-digit'});

    function deriveStatus(r){
      // Normalize a single source of truth for status
      const now = Date.now();
      const start = Date.parse(r.start_time || r.start || '');
      const canceled = !!(r.canceled_at || r.cancel_reason || r.status === true || r.status === 'canceled');
      const noShow = (String(r.no_show || '').toLowerCase().includes('true')) || (r.no_show === 'Marked as No Show');
      if (noShow) return 'No-Show';
      if (canceled) return 'Canceled';
      if (!isNaN(start) && start < now) return 'Completed';
      return 'Scheduled';
    }

    function topicOf(r){
      const t = (r.question_2_topic || r.topic || '').trim();
      return t || 'Unspecified';
    }

    function minutesBetween(start,end){
      const s = Date.parse(start), e = Date.parse(end);
      if (isNaN(s) || isNaN(e)) return 0;
      return Math.max(0, Math.round((e-s)/60000));
    }

    // =======================
    // Charts (bounded by .chart-wrap height)
    // =======================
    let lineChart, topicChart;

    function renderLine(datesCompleted, datesCanceled){
      const labels = Array.from(new Set([...Object.keys(datesCompleted), ...Object.keys(datesCanceled)])).sort((a,b)=>new Date(a)-new Date(b));
      const comp = labels.map(k=>datesCompleted[k]||0);
      const canc = labels.map(k=>datesCanceled[k]||0);

      lineChart && lineChart.destroy();
      lineChart = new Chart(document.getElementById('line'), {
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'Completed', data:comp, borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,.15)', tension:.35, fill:true, pointRadius:2},
            {label:'Canceled', data:canc, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,.12)', tension:.35, fill:true, pointRadius:2},
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:true, aspectRatio: 2.2,
          plugins:{ legend:{ display:true, position:'top' } },
          scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
        }
      });
    }

    function renderTopics(counts){
      const labels = Object.keys(counts);
      const data = labels.map(l=>counts[l]);
      const colors = labels.map(l=>TOPIC_COLORS[l] || '#94a3b8');

      topicChart && topicChart.destroy();
      topicChart = new Chart(document.getElementById('topics'), {
        type:'doughnut',
        data:{ labels, datasets:[{ data, backgroundColor:colors, borderWidth:0 }] },
        options:{
          responsive:true, maintainAspectRatio:true, aspectRatio:1.5,
          plugins:{ legend:{ display:false } },
          cutout:'60%'
        }
      });

      const legend = document.getElementById('topicLegend');
      legend.innerHTML = '';
      labels.forEach((l)=>{
        const span = document.createElement('span');
        span.innerHTML = `<span class="dot" style="background:${TOPIC_COLORS[l]||'#94a3b8'}"></span>${l}`;
        legend.appendChild(span);
      });
    }

    // =======================
    // No-Show action
    // =======================
    async function markNoShow(event_uuid){
      try{
        const url = `${GAS_URL}?action=markNoShow&event_uuid=${encodeURIComponent(event_uuid)}`;
        const res = await jsonp(url);
        if(res && res.ok){
          // Refresh quickly without reloading everything heavy → re-mark the row in-place
          const rowEl = document.querySelector(`[data-euid="${CSS.escape(event_uuid)}"]`);
          if (rowEl){
            const badge = rowEl.querySelector('[data-status]');
            badge.textContent = 'No-Show';
            badge.className = 'status noshow';
          }
        }else{
          alert('Could not mark no-show.');
        }
      }catch(err){
        console.error(err);
        alert('Request failed.');
      }
    }

    // Expose for button onclick
    window.markNoShow = markNoShow;

    // =======================
    // Load + render
    // =======================
    (async function load(){
      document.getElementById('loadState').textContent = 'Loading…';

      try{
        const data = await jsonp(`${GAS_URL}?action=fetch&rangeDays=${RANGE_DAYS}`);
        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data)?data:[]);

        // quick guard
        if(!items.length){
          document.getElementById('loadState').textContent = 'Loaded (0)';
          return;
        }

        // Normalization
        const rows = items.map(r=>{
          const topic = topicOf(r);
          const status = deriveStatus(r);
          const schedMin = minutesBetween(r.start_time, r.end_time) || r.scheduled_minutes || 20;
          const zoomMin = Number(r.zoom_duration_min) || null;
          const actualMin = zoomMin ?? schedMin;
          return {
            event_uuid: (r.event_uuid || '').replace('https://api.calendly.com/scheduled_events/',''),
            start: r.start_time, end: r.end_time, created_at: r.created_at,
            attendee: r.attendee_name || '', email: r.attendee_email || '',
            topic, status, schedMin, zoomMin, actualMin, zoom_url: r.zoom_url || ''
          };
        });

        // Stats
        const total = rows.length;
        const zoomAvail = rows.filter(r=>r.zoomMin!=null).length;
        const totalActualMin = rows.reduce((a,b)=>a + b.actualMin, 0);
        const avgMin = Math.round(totalActualMin / Math.max(1,total));
        const noShowRate = Math.round(100 * rows.filter(r=>r.status==='No-Show').length / Math.max(1,total));

        document.getElementById('totalMeetings').textContent = total.toString();
        document.getElementById('zoomCount').textContent = String(zoomAvail);
        document.getElementById('zoomTotal').textContent = String(total);
        document.getElementById('actualHours').textContent = (totalActualMin/60).toFixed(1);
        document.getElementById('avgMin').textContent = String(avgMin);
        document.getElementById('noShowRate').textContent = `${noShowRate}%`;
        document.getElementById('zoomProgress').textContent = `Zoom lookups: ${zoomAvail}/${total}`;

        // Time series
        const byDayCompleted = {}, byDayCanceled = {};
        rows.forEach(r=>{
          const d = new Date(r.start);
          const key = d.toISOString().slice(0,10);
          if(r.status==='Canceled') byDayCanceled[key]=(byDayCanceled[key]||0)+1;
          else if(r.status==='Completed' || r.status==='No-Show') byDayCompleted[key]=(byDayCompleted[key]||0)+1;
        });
        renderLine(byDayCompleted, byDayCanceled);

        // Topics
        const topicCounts = {};
        rows.forEach(r=>{ topicCounts[r.topic]=(topicCounts[r.topic]||0)+1; });
        renderTopics(topicCounts);

        // Table (limit to last 100 for speed)
        const tbody = document.getElementById('rows');
        tbody.innerHTML = '';
        rows
          .sort((a,b)=>Date.parse(b.start)-Date.parse(a.start))
          .slice(0,100)
          .forEach(r=>{
            const tr = document.createElement('tr');
            tr.setAttribute('data-euid', r.event_uuid);
            tr.innerHTML = `
              <td>${fmtDate(new Date(r.start))}</td>
              <td>${fmtTime(new Date(r.start))}</td>
              <td>${r.attendee}</td>
              <td>${r.email}</td>
              <td>${r.topic}</td>
              <td><span class="status ${r.status==='Scheduled'?'scheduled':r.status==='Canceled'?'canceled':r.status==='No-Show'?'noshow':'completed'}" data-status>${r.status}</span></td>
              <td>${r.schedMin}</td>
              <td>${r.zoomMin==null?'—':r.zoomMin}</td>
              <td>
                <button class="btn" onclick="markNoShow('${r.event_uuid}')">Mark No-Show</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

        document.getElementById('loadState').textContent = 'Loaded';
      }catch(err){
        console.error(err);
        document.getElementById('loadState').textContent = 'Error loading';
        alert('Failed to load data. Check your GAS URL and that it supports JSONP.');
      }
    })();
  </script>
</body>
</html>
