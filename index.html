<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shepherd Meeting Analytics</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#645fd1; --card:#f3f5f9; --ink:#2e3440; --ink-weak:#697285;
    --ok:#16a34a; --warn:#eab308; --bad:#ef4444; --chip:#e8eef8;
  }
  html,body{margin:0;background:linear-gradient(180deg,#706be6,#5c58c6);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
  .wrap{max-width:1080px;margin:22px auto;padding:6px 10px;}
  .toolbar{display:flex;justify-content:space-between;align-items:center;background:#fff3;padding:18px 22px;border-radius:14px;color:#fff}
  .h{display:flex;gap:10px;align-items:center}
  .h .dot{width:12px;height:12px;border-radius:50%;background:#9ec5ff;box-shadow:0 0 0 3px #ffffff22 inset}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-top:18px}
  .card{background:#ffffffe6;border-radius:16px;box-shadow:0 12px 30px #00000014;padding:18px}
  .kpi .t{color:var(--ink-weak);text-transform:uppercase;font-weight:600;letter-spacing:.06em}
  .kpi .v{font-size:34px;font-weight:700;margin-top:8px;color:var(--ink)}
  .sub{font-size:12px;color:var(--ink-weak);margin-top:6px}
  .row{display:grid;grid-template-columns:1.2fr .9fr;gap:18px;margin-top:18px}
  canvas#line{width:100%!important;height:320px!important}
  #topics{width:100%!important;height:320px!important}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px 10px;border-bottom:1px solid #eef1f6}
  th{font-size:12px;letter-spacing:.04em;text-transform:uppercase;color:var(--ink-weak);text-align:left;background:#f7f8fc}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .scheduled{background:#e8f0ff;color:#2f5bd4}
  .completed{background:#e8faef;color:#107a3a}
  .canceled{background:#ffebe8;color:#b42318}
  .noshow{background:#fff1c2;color:#8a6100}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #f6a733;color:#8a4b00;background:#fff6e5;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .flex{display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--ink-weak);font-size:12px}
  .legend{display:flex;gap:14px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);padding:4px 8px;border-radius:8px;font-size:12px}
  .chip i{display:inline-block;width:10px;height:10px;border-radius:3px;background:#ccc}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="h"><span class="dot"></span><strong>Shepherd Meeting Analytics</strong></div>
    <div class="muted"><span id="rangeLabel">Last 90 days</span> • <span id="loadedCount">Loaded (0)</span></div>
  </div>

  <div class="grid">
    <div class="card kpi"><div class="t">Total Meetings</div><div class="v" id="kpiTotal">—</div><div class="sub">Zoom lookups: <span id="zoomHits">0</span>/<span id="zoomTotal">0</span></div></div>
    <div class="card kpi"><div class="t">Meeting Hours</div><div class="v" id="kpiHours">0.0</div><div class="sub">Zoom duration is used when available</div></div>
    <div class="card kpi"><div class="t">Avg Duration (min)</div><div class="v" id="kpiAvg">0</div></div>
    <div class="card kpi"><div class="t">No-Show Rate</div><div class="v" id="kpiNoShow">0%</div></div>
  </div>

  <div class="row">
    <div class="card">
      <div class="t" style="color:var(--ink-weak);font-weight:700">Meetings Over Time</div>
      <canvas id="line"></canvas>
    </div>
    <div class="card">
      <div class="flex">
        <div class="t" style="color:var(--ink-weak);font-weight:700">Meeting Topics Breakdown</div>
      </div>
      <canvas id="topics"></canvas>
    </div>
  </div>

  <div class="card" style="margin-top:18px">
    <div class="flex"><strong>Recent Meetings</strong><div class="muted">Zoom duration is used when available</div></div>
    <div class="muted" style="margin:6px 0 10px">Zoom lookups: <span id="zoomHits2">0</span>/<span id="zoomTotal2">0</span></div>
    <table id="tbl">
      <thead>
        <tr>
          <th>Start</th><th>Attendee</th><th>Email</th><th>Topic</th><th>Status</th><th>Zoom Minutes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script>
/* ====== CONFIG — put your **single** Apps Script EXEC URL here ====== */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxeOlR6Pl6bpI14-fyz3ydjqNNFandUpfPKc5cU7AdFzs_fi9uCEzQ4KaVcQiEly33jPg/exec';

/* ====== tiny JSONP ====== */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const sep = url.includes('?')?'&':'?';
    s.src = url + sep + 'jsonp=' + cb;
    s.onerror = ()=>reject(new Error('JSONP failed'));
    window[cb] = (data)=>{ resolve(data); cleanup(); };
    function cleanup(){ delete window[cb]; s.remove(); }
    document.body.appendChild(s);
  });
}

const TOPIC_COLORS = {
  'Invoices':'#3b82f6','Forms':'#fb7185','Other':'#f59e0b','Reporting':'#fbbf24',
  'Inventory':'#2dd4bf','Messaging/Client Communications':'#8b5cf6','SOAP':'#cbd5e1',
  'Products':'#60a5fa','Reminders':'#f472b6','Scheduling':'#f59e0b','Clients/Patients':'#fde047'
};

let RAW = [];
let ZMAP = {}; // id -> {minutes}
let CH_LINE, CH_DONUT;

function fmtMin(n){ return n ? (n|0) + 'm' : '—'; }
function clsStatus(s){ s=(s||'').toLowerCase(); if(s==='completed')return'completed'; if(s==='canceled')return'canceled'; if(s==='no-show')return'noshow'; return'scheduled'; }

function extractId(zoom_url_cell){
  // "Zoom URL: https://.../j/85172082988?pwd=..."
  const m = String(zoom_url_cell||'').match(/zoom\.us\/j\/(\d{9,})/i);
  return m ? m[1] : '';
}

async function load(){
  document.getElementById('rangeLabel').textContent = 'Last 90 days';
  // 1) fetch rows
  const data = await jsonp(`${GAS_URL}?action=fetch&rangeDays=90`);
  if (data.error) throw new Error(data.error);
  RAW = data.items || [];
  document.getElementById('loadedCount').textContent = `Loaded (${RAW.length})`;

  // 2) pull zoom ids
  const ids = [...new Set(RAW.map(r=>extractId(r.zoom_url)).filter(Boolean))];
  document.getElementById('zoomTotal').textContent = ids.length;
  document.getElementById('zoomTotal2').textContent = ids.length;

  // 3) ask server to enrich (also writes minutes to sheet)
  if (ids.length){
    const z = await jsonp(`${GAS_URL}?action=zoomBatch&ids=${encodeURIComponent(ids.join(','))}`);
    ZMAP = z.map || {};
    document.getElementById('zoomHits').textContent = z.hits||0;
    document.getElementById('zoomHits2').textContent = z.hits||0;

    // merge into RAW
    RAW = RAW.map(r=>{
      const id = extractId(r.zoom_url);
      const minutes = (id && ZMAP[id] && ZMAP[id].minutes) ? ZMAP[id].minutes : (r.zoom_minutes||0);
      const status = (r.no_show) ? 'No-Show'
                   : (minutes>0) ? 'Completed'
                   : (String(r.status_raw).toLowerCase()==='canceled' || r.canceled_at) ? 'Canceled'
                   : 'Scheduled';
      return {...r, zoom_minutes: minutes, status};
    });
  }

  paint();
}

function paint(){
  // KPIs
  const total = RAW.length;
  const minutesList = RAW.map(r=>r.zoom_minutes||0);
  const minutesSum = minutesList.reduce((a,b)=>a+b,0);
  const noShows = RAW.filter(r=>r.status==='No-Show').length;

  document.getElementById('kpiTotal').textContent = total;
  document.getElementById('kpiHours').textContent = (minutesSum/60).toFixed(1);
  document.getElementById('kpiAvg').textContent = total ? Math.round(minutesSum/total) : 0;
  document.getElementById('kpiNoShow').textContent = total ? Math.round(noShows*100/total)+'%' : '0%';

  // Table
  const tbody = document.getElementById('rows'); tbody.innerHTML='';
  RAW.sort((a,b)=>a.start_time.localeCompare(b.start_time)).reverse();
  for (const r of RAW){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(r.start_time).toLocaleString()}</td>
      <td>${r.attendee_name||''}</td>
      <td>${r.attendee_email||''}</td>
      <td>${r.topic||'—'}</td>
      <td><span class="badge ${clsStatus(r.status)}">${r.status}</span></td>
      <td>${fmtMin(r.zoom_minutes)}</td>
      <td>
        <button class="btn" data-uuid="${r.event_uuid}" data-ns="${r.status==='No-Show'?'false':'true'}">
          ${r.status==='No-Show'?'Unmark No-Show':'Mark No-Show'}
        </button>
      </td>`;
    tbody.appendChild(tr);
  }
  tbody.onclick = async (e)=>{
    const btn = e.target.closest('button.btn'); if (!btn) return;
    btn.disabled = true; btn.textContent = 'Saving…';
    const uuid = btn.getAttribute('data-uuid');
    const set = btn.getAttribute('data-ns')==='true';
    const res = await jsonp(`${GAS_URL}?action=markNoShow&uuid=${encodeURIComponent(uuid)}&set=${set}`);
    if (!res || res.error){ btn.textContent='Error'; btn.disabled=false; return; }
    // reflect in RAW
    RAW = RAW.map(r => r.event_uuid===uuid ? {...r, no_show:set, status: set?'No-Show':(r.zoom_minutes>0?'Completed':'Scheduled')} : r);
    paint(); // re-render KPIs + table
  };

  // Charts
  renderCharts();
}

function renderCharts(){
  // destroy any previous charts (prevents canvas growth)
  if (CH_LINE){ CH_LINE.destroy(); }
  if (CH_DONUT){ CH_DONUT.destroy(); }

  // Line: meetings per day
  const byDay = {};
  RAW.forEach(r=>{
    const k = new Date(r.start_time).toISOString().slice(0,10);
    byDay[k] = (byDay[k]||0)+1;
  });
  const labels = Object.keys(byDay).sort();
  const values = labels.map(k=>byDay[k]);

  CH_LINE = new Chart(document.getElementById('line').getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ label:'Meetings', data:values, tension:.35, pointRadius:3, borderWidth:3 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } },
      plugins:{ legend:{ display:false } }
    }
  });

  // Donut: topics
  const counts = {};
  RAW.forEach(r=>{
    const t = r.topic || 'Other';
    counts[t] = (counts[t]||0)+1;
  });
  const tLabels = Object.keys(counts).sort();
  const tData = tLabels.map(k=>counts[k]);
  const tColors = tLabels.map(k=>TOPIC_COLORS[k]||'#94a3b8');

  CH_DONUT = new Chart(document.getElementById('topics').getContext('2d'), {
    type:'doughnut',
    data:{ labels:tLabels, datasets:[{ data:tData, backgroundColor:tColors, hoverOffset:4, borderWidth:0 }] },
    options:{ plugins:{ legend:{ position:'top', labels:{ usePointStyle:true, pointStyle:'rectRounded' } } } }
  });
}

load().catch(err=>{
  console.error(err);
  alert('Failed to load data. Check your GAS URL and that it supports JSONP.');
});
</script>
<!-- No SRI to avoid blocking -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</body>
</html>
