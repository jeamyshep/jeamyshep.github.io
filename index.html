<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shepherd Meeting Analytics</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/inter@5.0.20/variable.css">
<style>
  :root { --bg:#5c5ed6; --panel:#f6f7fb; --ink:#2b2f42; --muted:#7b8194; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:#e7eefc }
  *{box-sizing:border-box} html,body{height:100%;margin:0}
  body{font-family:'InterVariable',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#5b5ed4,#6a69d8) fixed;color:var(--ink)}
  .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border-radius:22px;box-shadow:0 6px 18px rgba(10,10,40,.15)}
  .header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;margin-bottom:16px}
  .h1{font-weight:800;font-size:26px;display:flex;gap:10px;align-items:center}
  .h1::before{content:"";width:16px;height:16px;border-radius:4px;background:linear-gradient(135deg,#6a84ff,#6ae0ff)}
  .chips{display:flex;gap:10px}
  .chip{background:#eef2ff;color:#334155;border-radius:999px;padding:8px 12px;font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
  .stat{padding:18px}
  .stat .t{font-size:12px;color:var(--muted);letter-spacing:.06em}
  .stat .v{margin-top:8px;font-size:36px;font-weight:800}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .pad{padding:18px}
  #topicCard{min-height:390px}
  .table{margin-top:18px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{color:var(--muted);font-weight:700;text-align:left;background:#f4f6fc}
  th,td{padding:14px 12px;border-bottom:1px solid #eef1f7}
  .pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block}
  .pill.ok{background:#dcfce7;color:#065f46}
  .pill.bad{background:#fee2e2;color:#7f1d1d}
  .pill.neu{background:#e0e7ff;color:#1e40af}
  .btn{border:1px solid #f7b267;background:#fff7ed;color:#c2410c;border-radius:14px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted);font-size:12px}
  /* ensure crisp charts on HiDPI & no infinite growth */
  canvas{width:100% !important;height:320px !important;display:block}
  #line{height:340px !important}
  #topic{height:340px !important}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
        integrity="sha512-CQBWl4fJHWbryGE+Pc7UAxWMUMNMWzWxF4SQo9CgkJIN1kx6djDQZjh3Y8SZ1d+6I+1zze6Z7kHXO7q3UyZAWw=="
        crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <div class="card header">
      <div class="h1">Shepherd Meeting Analytics</div>
      <div class="chips">
        <div id="rangeChip" class="chip">Last <span id="rangeDays">90</span> days</div>
        <div id="loadedChip" class="chip">Loaded (<span id="loadedCount">0</span>)</div>
      </div>
    </div>

    <div class="grid">
      <div class="card stat">
        <div class="t">TOTAL MEETINGS</div>
        <div class="v" id="statTotal">–</div>
        <div class="muted">Zoom lookups: <span id="zoomHits">0</span>/<span id="zoomTotal">0</span></div>
      </div>
      <div class="card stat">
        <div class="t">MEETING HOURS</div>
        <div class="v" id="statHours">0.0</div>
        <div class="muted">Zoom duration is used when available</div>
      </div>
      <div class="card stat">
        <div class="t">AVG DURATION (MIN)</div>
        <div class="v" id="statAvg">0</div>
      </div>
      <div class="card stat">
        <div class="t">NO-SHOW RATE</div>
        <div class="v" id="statNoShow">0%</div>
      </div>
    </div>

    <div class="row">
      <div class="card pad"><div class="t">Meetings Over Time</div><canvas id="line"></canvas></div>
      <div id="topicCard" class="card pad">
        <div class="t" style="font-size:20px;font-weight:800;margin-bottom:6px">Meeting Topics Breakdown</div>
        <canvas id="topic"></canvas>
      </div>
    </div>

    <div class="card table pad">
      <div class="t" style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Recent Meetings</strong></div>
        <div class="muted">Zoom duration is used when available</div>
      </div>
      <div class="muted" style="margin:6px 0 10px">Zoom lookups: <span id="zoomHits2">0</span>/<span id="zoomTotal2">0</span></div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Start</th><th>Attendee</th><th>Email</th><th>Topic</th>
              <th>Status</th><th>Zoom Minutes</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbz83fgIJPvRPIByVINZjB4zFExW7pV_Kn_04LLQ7PUV9XKBWPEW10vkHVn-EczWL5xpdg/exec';  // one URL for everything
const RANGE_DAYS = 90;

/* ====== JSONP helper (stable, with timeout) ====== */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = 'gas_cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const t = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, 20000);
    function cleanup(){ clearTimeout(t); s.remove(); delete window[cb]; }
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    s.onerror = ()=>{ cleanup(); reject(new Error('JSONP failed')); };
    s.src = url + (url.includes('?')?'&':'?') + 'jsonp=' + cb + '&ts=' + Date.now();
    document.body.appendChild(s);
  });
}

/* ====== UI state ====== */
let ITEMS = [];
let ZOOM_MAP = {};
let charts = { line:null, topic:null };

/* ====== Load & Enrich ====== */
async function load(){
  document.getElementById('rangeDays').textContent = RANGE_DAYS;
  const data = await jsonp(`${GAS_URL}?action=fetch&rangeDays=${RANGE_DAYS}`);
  if (data.error) throw new Error(data.error);
  ITEMS = data.items || [];
  document.getElementById('loadedCount').textContent = String(ITEMS.length);
  renderBase(ITEMS);

  // Zoom enrichment
  const urls = ITEMS
    .map(x => (x.zoom_url || '').replace(/^.*https?:\/\//,'https://')) // strip "Zoom URL: "
    .filter(u => u.includes('/j/'));                                    // keep only real links
  document.getElementById('zoomTotal').textContent =
  document.getElementById('zoomTotal2').textContent = String(urls.length);

  if (urls.length){
    const uniq = [...new Set(urls)];
    const resp = await jsonp(`${GAS_URL}?action=zoomBatch&` + new URLSearchParams({ urls: uniq.join(',') }));
    const map = (resp && resp.map) || {};
    ZOOM_MAP = map;
    const hits = Object.keys(map).length;
    document.getElementById('zoomHits').textContent =
    document.getElementById('zoomHits2').textContent = String(hits);

    // write back minutes to sheet
    if (hits){
      const writeRes = await jsonp(`${GAS_URL}?action=writeZoomMinutes&` + new URLSearchParams({ map: JSON.stringify(map) }));
      // re-merge into ITEMS for display & stats
      ITEMS = ITEMS.map(it => map[it.event_uuid] ? { ...it, zoom_minutes: map[it.event_uuid], status: (it.status==='No-Show'||it.status==='Canceled')?it.status:'Completed' } : it);
      renderBase(ITEMS); // re-render with minutes + recomputed stats
    }
  }
}

/* ====== Rendering ====== */
function mins(n){ return n>0 ? `${n}m` : '—'; }
function pill(status){
  const s = (status||'Scheduled').toLowerCase();
  if (s==='completed') return '<span class="pill ok">Completed</span>';
  if (s==='canceled' || s==='cancelled') return '<span class="pill bad">Canceled</span>';
  if (s==='no-show') return '<span class="pill bad">No-Show</span>';
  return '<span class="pill neu">Scheduled</span>';
}

function renderBase(list){
  // Stats
  document.getElementById('statTotal').textContent = String(list.length);
  const totalZoom = list.reduce((a,b)=> a + (Number(b.zoom_minutes)||0), 0);
  const completedOrZoom = list.filter(x => (x.zoom_minutes>0) || x.status==='Completed');
  const avg = completedOrZoom.length ? Math.round(totalZoom / completedOrZoom.length) : 0;
  const noShows = list.filter(x => (x.status||'').toLowerCase()==='no-show').length;
  document.getElementById('statHours').textContent = (totalZoom/60).toFixed(1);
  document.getElementById('statAvg').textContent = String(avg);
  document.getElementById('statNoShow').textContent = Math.round((noShows/(list.length||1))*100)+'%';

  // Table
  const rows = document.getElementById('rows');
  rows.innerHTML = '';
  list.slice().sort((a,b)=> new Date(b.start_time)-new Date(a.start_time)).forEach(it=>{
    const btnLabel = (String(it.no_show).toLowerCase()==='true' || (it.status||'').toLowerCase()==='no-show')
      ? 'Unmark No-Show' : 'Mark No-Show';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(it.start_time).toLocaleString()}</td>
      <td>${it.attendee_name||'—'}</td>
      <td>${it.attendee_email||'—'}</td>
      <td>${it.topic||'—'}</td>
      <td>${pill(it.status)}</td>
      <td>${mins(Number(it.zoom_minutes||0))}</td>
      <td><button class="btn" data-uuid="${it.event_uuid}" data-noshow="${btnLabel.startsWith('Unmark')?'false':'true'}">${btnLabel}</button></td>
    `;
    rows.appendChild(tr);
  });

  // Actions: toggle no-show
  rows.querySelectorAll('button.btn').forEach(b=>{
    b.addEventListener('click', async (e)=>{
      const btn = e.currentTarget;
      const uuid = btn.getAttribute('data-uuid');
      const setTo = btn.getAttribute('data-noshow') === 'true';
      const label0 = btn.textContent;
      btn.textContent = 'Saving…';
      btn.disabled = true;
      try{
        const res = await jsonp(`${GAS_URL}?action=toggleNoShow&uuid=${encodeURIComponent(uuid)}&value=${setTo?'true':'false'}`);
        if (res && res.ok){
          // update local item & re-render
          ITEMS = ITEMS.map(it=>{
            if (it.event_uuid===uuid){
              const s = setTo ? 'No-Show' : 'Scheduled';
              return { ...it, status: s, no_show: setTo?'true':'' };
            }
            return it;
          });
          renderBase(ITEMS);
        } else { throw new Error(res && res.error || 'save failed'); }
      } catch(err){
        alert('Failed to update: ' + err.message);
        btn.textContent = label0; btn.disabled = false;
      }
    });
  });

  // Charts — destroy & rebuild with crisp sizing and no infinite growth
  charts.line && charts.line.destroy();
  charts.topic && charts.topic.destroy();

  const ctxL = document.getElementById('line').getContext('2d');
  const byDay = {};
  list.forEach(it=>{
    const d = new Date(it.start_time);
    const key = d.toISOString().slice(0,10);
    byDay[key] = (byDay[key]||0)+1;
  });
  const labels = Object.keys(byDay).sort();
  charts.line = new Chart(ctxL,{
    type:'line',
    data:{ labels, datasets:[{ label:'Completed', data: labels.map(k=>byDay[k]), tension:.25, pointRadius:2 }] },
    options:{ responsive:true, maintainAspectRatio:false, devicePixelRatio: window.devicePixelRatio || 2,
      scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 } } }, plugins:{ legend:{ display:false } }
    }
  });

  const ctxT = document.getElementById('topic').getContext('2d');
  const topicCounts = {};
  list.forEach(it=>{
    const t = (it.topic||'Unspecified').trim();
    topicCounts[t] = (topicCounts[t]||0)+1;
  });
  const topicLabels = Object.keys(topicCounts);
  const topicData = topicLabels.map(k=>topicCounts[k]);
  const PALETTE = [
    '#3b82f6','#fb7185','#f59e0b','#fde047','#14b8a6','#8b5cf6','#9ca3af',
    '#60a5fa','#f87171','#22c55e','#fbbf24','#eab308'
  ];
  charts.topic = new Chart(ctxT,{
    type:'doughnut',
    data:{ labels:topicLabels, datasets:[{ data:topicData, backgroundColor: topicLabels.map((_,i)=>PALETTE[i%PALETTE.length]) }] },
    options:{ responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{ legend:{ position:'top', labels:{ boxWidth:22 } } } }
  });
}

/* boot */
load().catch(err=>{
  console.error(err);
  alert('Failed to load data. Check your GAS URL & deployment.');
});
</script>
</body>
</html>
