<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meeting Analytics Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica','Arial',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px
    }
    .dashboard{max-width:1400px;margin:0 auto;animation:fadeIn .5s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;margin-bottom:30px;box-shadow:0 10px 40px rgba(0,0,0,.1)}
    .header h1{color:#2d3748;font-size:32px;font-weight:700;margin-bottom:10px}
    .date-range{display:inline-flex;align-items:center;gap:10px;background:#f7fafc;padding:10px 20px;border-radius:10px;color:#718096;font-size:14px;margin-top:15px;transition:.3s;cursor:pointer}
    .date-range:hover{background:#edf2f7;transform:translateY(-2px)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:25px;box-shadow:0 10px 40px rgba(0,0,0,.1);transition:.3s cubic-bezier(.4,0,.2,1);cursor:pointer;position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea,#764ba2);transform:scaleX(0);transition:transform .3s}
    .stat-card:hover::before{transform:scaleX(1)}
    .stat-card:hover{transform:translateY(-5px);box-shadow:0 20px 60px rgba(0,0,0,.15)}
    .stat-label{color:#718096;font-size:14px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
    .stat-value{color:#2d3748;font-size:36px;font-weight:700;margin-bottom:10px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .stat-change{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;font-size:12px;font-weight:600}
    .stat-change.positive{background:#c6f6d5;color:#22543d}
    .stat-change.negative{background:#fed7d7;color:#742a2a}
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:20px;margin-bottom:30px}
    .chart-card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.1);transition:.3s}
    .chart-card:hover{transform:translateY(-5px);box-shadow:0 20px 60px rgba(0,0,0,.15)}
    .chart-title{color:#2d3748;font-size:18px;font-weight:600;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between}
    .chart-container{position:relative;height:300px}
    .table-card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.1);margin-bottom:30px}
    .table-card h2{color:#2d3748;font-size:20px;font-weight:600;margin-bottom:20px}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:15px;background:#f7fafc;color:#4a5568;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid #e2e8f0}
    td{padding:15px;color:#2d3748;border-bottom:1px solid #e2e8f0;font-size:14px;transition:background .2s}
    tr:hover td{background:#f7fafc}
    .badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600}
    .badge.completed{background:#c6f6d5;color:#22543d}
    .badge.pending{background:#fef5e7;color:#7d6608}
    .badge.cancelled{background:#fed7d7;color:#742a2a}
    .spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(102,126,234,.3);border-radius:50%;border-top-color:#667eea;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:768px){.charts-grid{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <h1>ðŸ“Š Meeting Analytics</h1>
      <div class="date-range">ðŸ“… Last 30 Days</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Meetings</div>
        <div class="stat-value">â€”</div>
        <span class="stat-change positive" title="MoM">â†‘</span>
      </div>
      <div class="stat-card">
        <div class="stat-label">Meeting Hours</div>
        <div class="stat-value">â€”</div>
        <span class="stat-change positive" title="MoM">â†‘</span>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Duration</div>
        <div class="stat-value">â€”</div>
        <span class="stat-change negative" title="MoM">â†“</span>
      </div>
      <div class="stat-card">
        <div class="stat-label">No-show Rate</div>
        <div class="stat-value">â€”</div>
        <span class="stat-change positive" title="MoM">â†“</span>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3 class="chart-title">
          Meetings Over Time
          <span class="spinner" id="spinner1" style="display:none;"></span>
        </h3>
        <div class="chart-container">
          <canvas id="meetingsChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3 class="chart-title">
          Meeting Types Distribution
          <span class="spinner" id="spinner2" style="display:none;"></span>
        </h3>
        <div class="chart-container">
          <canvas id="typesChart"></canvas>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3 class="chart-title">Popular Time Slots</h3>
        <div class="chart-container">
          <canvas id="timeSlotsChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3 class="chart-title">Day of Week Distribution</h3>
        <div class="chart-container">
          <canvas id="dayChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-card">
      <h2>Recent Meetings</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Time</th><th>Type</th><th>Attendee</th><th>Duration</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
  // â¬‡ï¸ Set this to your Apps Script Web App (or proxy) URL that returns JSON
  const DASHBOARD_DATA_URL = "YOUR_DATA_URL_HERE";

  // ---- helpers ----
  const fmtDate  = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  const fmtTime  = d => d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  const durationMin = (a,b)=> Math.max(0, Math.round((b-a)/60000));

  // Normalize header names like "Start Time", "start_time", "StartTime" -> "start_time"
  const normKey = k => String(k||'')
    .trim()
    .toLowerCase()
    .replace(/[\s\-]+/g, '_')
    .replace(/[^\w]/g, '');

  // Parse many date formats, including serials
  function parseDate(val) {
    if (!val && val !== 0) return NaN;

    // If Sheets Apps Script returns a Date, it may already be a string ISO
    if (val instanceof Date) return +val;
    if (typeof val === 'string') {
      // Common mm/dd/yyyy [hh:mm] [am/pm]
      const s = val.trim();
      const iso = Date.parse(s);
      if (!Number.isNaN(iso)) return iso;

      // Try replacing space before AM/PM with 'T' to help parsing
      const m = s.match(/^(\d{1,2}\/\d{1,2}\/\d{2,4})\s+(\d{1,2}:\d{2})(?:\s*(AM|PM))?$/i);
      if (m) {
        const base = new Date(m[1] + ' ' + m[2] + (m[3] ? ' ' + m[3].toUpperCase() : ''));
        if (!Number.isNaN(+base)) return +base;
      }
    }

    // Excel/Sheets serial dates (days since 1899-12-30)
    if (typeof val === 'number' && val > 25569 && val < 60000) {
      const ms = (val - 25569) * 86400 * 1000;
      return ms;
    }

    return Number(val); // try numeric epoch ms/seconds if provided
  }

  // Safely turn payload into array of rows (supports multiple shapes)
  function toItems(payload) {
    if (Array.isArray(payload?.items)) return payload.items;
    if (Array.isArray(payload)) return payload;

    // Google Sheets "values" shape
    if (Array.isArray(payload?.values)) {
      const [header, ...rows] = payload.values;
      const H = (header||[]).map(normKey);
      return rows.map(r => Object.fromEntries(H.map((h,i)=>[h, r[i]])));
    }

    // Object keyed by id
    if (payload && typeof payload === 'object') {
      const vals = Object.values(payload);
      if (Array.isArray(vals) && vals.length && typeof vals[0] === 'object') return vals;
    }
    return [];
  }

  // Extract a field by trying many common key variants
  function getField(row, variants) {
    for (const v of variants) {
      const k = normKey(v);
      if (row[k] !== undefined && row[k] !== null && row[k] !== '') return row[k];
    }
    return undefined;
  }

  async function loadData() {
    document.getElementById('spinner1').style.display = 'inline-block';
    document.getElementById('spinner2').style.display = 'inline-block';

    // Fetch & robustly parse, logging raw payload
    let payload = {};
    try {
      const res  = await fetch(DASHBOARD_DATA_URL, { cache: 'no-store' });
      const text = await res.text();
      try { payload = JSON.parse(text); }
      catch (e) {
        console.error('Non-JSON response:', text.slice(0, 500));
        payload = {};
      }
    } catch (e) {
      console.error('Fetch failed:', e);
      payload = {};
    }
    console.log('Raw payload:', payload);

    // Turn into array; normalize keys
    let items = toItems(payload);

    // If array of objects with mixed header styles, normalize row keys
    items = items.map(obj => {
      if (!obj || typeof obj !== 'object') return {};
      const out = {};
      for (const [k,v] of Object.entries(obj)) out[normKey(k)] = v;
      return out;
    });

    console.log('After normalization, first row:', items[0]);

    // Map fields with broad key support
    const START_KEYS = ['start_time','start','start_at','starttime','scheduled_start_time'];
    const END_KEYS   = ['end_time','end','end_at','endtime','scheduled_end_time'];
    const TYPE_KEYS  = ['event_type','type','event','title','meeting_type'];
    const NAME_KEYS  = ['attendee_name','name','guest','invitee_name','contact_name'];
    const STATUS_KEYS= ['status','state','meeting_status'];

    const now = new Date();
    const startWindow = new Date(now); startWindow.setDate(startWindow.getDate() - 29);

    // Build only rows with a parseable start time inside last 30 days
    const rows = items.map(r => {
      const sRaw = getField(r, START_KEYS);
      const eRaw = getField(r, END_KEYS);
      const tRaw = getField(r, TYPE_KEYS) || 'Other';
      const nRaw = getField(r, NAME_KEYS) || '';
      const stRaw= (getField(r, STATUS_KEYS) || '').toLowerCase();

      const s = parseDate(sRaw);
      const e = parseDate(eRaw);

      return {
        _valid: !Number.isNaN(s),
        start_ms: s,
        end_ms: Number.isNaN(e) ? NaN : e,
        event_type: String(tRaw || 'Other'),
        attendee_name: String(nRaw || ''),
        status: stRaw
      };
    }).filter(r => r._valid)
      .filter(r => {
        const s = new Date(r.start_ms);
        return s >= new Date(startWindow.toDateString()) && s <= now;
      });

    if (rows.length === 0) {
      console.warn('No usable rows found in the last 30 days. Check your field names and date formats.');
      banner('No data found in the last 30 days. Confirm your Sheet headers & Zap mapping.');
    }

    // ---- KPIs ----
    const totalMeetings = rows.length;
    const durations = rows.map(r => isNaN(r.end_ms) ? 0 : durationMin(new Date(r.start_ms), new Date(r.end_ms)));
    const hours = Math.round(durations.reduce((a,b)=>a+b,0) / 60);
    const avg   = Math.round((durations.reduce((a,b)=>a+b,0) / Math.max(1,durations.length)) || 0);
    const noShows = rows.filter(r => r.status === 'no_show' || r.status === 'no-show').length;

    document.querySelectorAll('.stat-value')[0].textContent = totalMeetings;
    document.querySelectorAll('.stat-value')[1].textContent = hours;
    document.querySelectorAll('.stat-value')[2].textContent = `${avg}m`;
    document.querySelectorAll('.stat-value')[3].textContent = totalMeetings ? `${Math.round((noShows/totalMeetings)*100)}%` : '0%';

    // ---- Time buckets (last 30 days) ----
    const labels = [];
    const key = d => `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    const buckets = {};
    for (let i=29;i>=0;i--) {
      const d = new Date(now); d.setDate(d.getDate()-i);
      labels.push(d.toLocaleDateString('en-US',{month:'short',day:'numeric'}));
      buckets[key(d)] = { completed:0, cancelled:0 };
    }
    rows.forEach(r => {
      const s = new Date(r.start_ms);
      const k = key(s);
      if (!buckets[k]) return;
      const st = r.status;
      if (st === 'cancelled' || st === 'canceled') buckets[k].cancelled++;
      else buckets[k].completed++;
    });

    // ---- Charts ----
    const ctx1 = document.getElementById('meetingsChart').getContext('2d');
    new Chart(ctx1, {
      type:'line',
      data:{ labels, datasets:[
        { label:'Completed', data:Object.values(buckets).map(b=>b.completed), borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.1)', tension:0.4, fill:true },
        { label:'Cancelled', data:Object.values(buckets).map(b=>b.cancelled), borderColor:'#fc8181', backgroundColor:'rgba(252,129,129,0.1)', tension:0.4, fill:true }
      ]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' } } }
    });

    const byType = {};
    rows.forEach(r => { byType[r.event_type || 'Other'] = (byType[r.event_type || 'Other']||0)+1; });
    const ctx2 = document.getElementById('typesChart').getContext('2d');
    new Chart(ctx2, {
      type:'doughnut',
      data:{ labels:Object.keys(byType), datasets:[{ data:Object.values(byType), backgroundColor:['#667eea','#764ba2','#f093fb','#96ceb4','#ffeaa7'], borderWidth:0 }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right' } } }
    });

    const hoursBuckets = Array(24).fill(0);
    rows.forEach(r => { hoursBuckets[new Date(r.start_ms).getHours()]++; });
    const labelsHours = ['12AM','1AM','2AM','3AM','4AM','5AM','6AM','7AM','8AM','9AM','10AM','11AM','12PM','1PM','2PM','3PM','4PM','5PM','6PM','7PM','8PM','9PM','10PM','11PM'];
    const ctx3 = document.getElementById('timeSlotsChart').getContext('2d');
    new Chart(ctx3, {
      type:'bar',
      data:{ labels:labelsHours, datasets:[{ label:'Meetings', data:hoursBuckets, backgroundColor:'rgba(102,126,234,0.8)', borderColor:'#667eea', borderRadius:10 }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
    });

    const dow = [0,0,0,0,0,0,0];
    rows.forEach(r => { dow[new Date(r.start_ms).getDay()]++; });
    const ctx4 = document.getElementById('dayChart').getContext('2d');
    new Chart(ctx4, {
      type:'radar',
      data:{ labels:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
        datasets:[{ label:'Meetings', data:dow, borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.2)' }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
    });

    // ---- Recent table ----
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = '';
    rows.sort((a,b)=> a.start_ms < b.start_ms ? 1 : -1)
        .slice(0,5)
        .forEach(r => {
          const s = new Date(r.start_ms), e = new Date(r.end_ms);
          const cls = (r.status === 'cancelled' || r.status === 'canceled') ? 'cancelled'
                    : (r.status === 'pending' ? 'pending' : 'completed');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(s)}</td>
            <td>${fmtTime(s)}</td>
            <td>${r.event_type || 'â€”'}</td>
            <td>${r.attendee_name || 'â€”'}</td>
            <td>${isNaN(+e) ? 'â€”' : durationMin(s,e)+' min'}</td>
            <td><span class="badge ${cls}">${(r.status||'completed').replace(/^./,m=>m.toUpperCase())}</span></td>
          `;
          tbody.appendChild(tr);
        });

    document.getElementById('spinner1').style.display = 'none';
    document.getElementById('spinner2').style.display = 'none';
  }

  function banner(msg) {
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.cssText = 'margin:10px 0 20px;color:#742a2a;background:#fed7d7;border:1px solid #f5b7b1;padding:10px 14px;border-radius:10px;font-weight:600';
    document.querySelector('.header').appendChild(el);
  }

  loadData();
</script>

</body>
</html>
