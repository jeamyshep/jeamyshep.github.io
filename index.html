<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Meeting Analytics</title>

  <!-- Chart.js (no integrity attr to avoid SRI mismatches) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2; --text:#2d3748; --muted:#718096;
      --card:#ffffff; --glass:rgba(255,255,255,0.95);
      --ok:#16a34a; --warn:#b45309; --bad:#b91c1c;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh; padding:20px; color:var(--text);
    }
    .dashboard{ max-width:1200px; margin:0 auto; }
    .header{ background:var(--glass); border-radius:20px; padding:24px; margin-bottom:20px; }
    h1{ font-weight:700; font-size:28px; }
    .date-range{ display:inline-flex; gap:8px; align-items:center; margin-top:8px; color:var(--muted); background:#f7fafc; border-radius:10px; padding:8px 12px; }

    .stats{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; margin:20px 0; }
    .card{ background:var(--glass); border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .label{ color:var(--muted); text-transform:uppercase; font-size:12px; letter-spacing:.5px; margin-bottom:8px; }
    .value{ font-size:28px; font-weight:700; background:linear-gradient(135deg,var(--bg1),var(--bg2)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
    .sub{ font-size:12px; color:var(--muted); margin-top:6px; }

    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(420px,1fr)); gap:16px; margin:16px 0 24px; }
    .chart-wrap{ background:var(--glass); border-radius:18px; padding:18px; }
    .chart-title{ display:flex; justify-content:space-between; align-items:center; font-weight:600; margin-bottom:10px; }
    .chart-box{ position:relative; height:300px; } /* fixed, prevents infinite growth */

    .table-card{ background:var(--glass); border-radius:18px; padding:18px; }
    table{ width:100%; border-collapse:collapse; }
    th{ text-align:left; padding:10px; font-size:12px; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); border-bottom:2px solid #e2e8f0; }
    td{ padding:10px; border-bottom:1px solid #e2e8f0; }
    tr:hover td{ background:#f7fafc; }
    .badge{ display:inline-block; padding:4px 10px; border-radius:10px; font-size:12px; font-weight:600; }
    .scheduled{ background:#eef2ff; color:#3730a3; }
    .completed{ background:#dcfce7; color:#166534; }
    .canceled{ background:#fee2e2; color:#991b1b; }
    .noshow{ background:#fef3c7; color:#92400e; }

    .btn{ font:inherit; border:0; border-radius:10px; padding:6px 10px; cursor:pointer; transition:transform .06s ease; }
    .btn:active{ transform:translateY(1px); }
    .btn-ghost{ background:#edf2f7; }
    .btn-primary{ background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; }
    .btn-loading{ opacity:.6; pointer-events:none; }

    .muted{ color:var(--muted); font-size:12px; }

    @media (max-width:700px){
      .chart-box{ height:260px; }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <h1>ðŸ“Š Shepherd Connect Analytics</h1>
      <div class="date-range" id="dateLabel">ðŸ“… Last 30 days</div>
    </div>

    <div class="stats">
      <div class="card">
        <div class="label">Total Meetings</div>
        <div class="value" id="statTotal">â€“</div>
        <div class="sub muted" id="statTotalSub"></div>
      </div>
      <div class="card">
        <div class="label">Meeting Hours (Zoom actual)</div>
        <div class="value" id="statHours">â€“</div>
        <div class="sub muted">Sum of actual Zoom minutes</div>
      </div>
      <div class="card">
        <div class="label">Avg Duration (Zoom actual)</div>
        <div class="value" id="statAvg">â€“</div>
        <div class="sub muted">Completed only</div>
      </div>
      <div class="card">
        <div class="label">No-show Rate</div>
        <div class="value" id="statNoShow">â€“</div>
        <div class="sub muted" id="statNoShowSub"></div>
      </div>
    </div>

    <div class="grid">
      <div class="chart-wrap">
        <div class="chart-title">Meetings Over Time<span class="muted" id="meetingsHint"></span></div>
        <div class="chart-box"><canvas id="meetingsLine"></canvas></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-title">Meeting Topics</div>
        <div class="chart-box"><canvas id="topicsPie"></canvas></div>
      </div>
    </div>

    <div class="table-card">
      <div class="chart-title">
        <span>Recent Meetings</span>
        <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
      </div>
      <table id="tbl">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time (ET)</th>
            <th>Attendee</th>
            <th>Topic</th>
            <th>Status</th>
            <th>Zoom mins</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="muted" style="margin-top:8px" id="tableHint"></div>
    </div>
  </div>

  <script>
    // ======= CONFIG =======
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxd9OLg33sCwj7jq6TJcxGRgVGBp_n4WBNqjBUOb41zQRWPO2nlSasy9ZwC-6gVb4L2-w/exec';
    const DATE_WINDOW_DAYS = 90; // adjust (label updates automatically)

    // Fixed color per topic label (case-insensitive keys)
const TOPIC_COLORS = {
  'invoices':              '#3B82F6',
  'forms':                 '#F87171',
  'other':                 '#F59E0B',
  'reporting':             '#FBBF24',
  'inventory':             '#34D399',
  'messaging/client communications': '#8B5CF6',
  'soap':                  '#D1D5DB',
  'products':              '#60A5FA',
  'reminders':             '#FB7185',
  'scheduling':            '#F59E0B',
  'clients/patients':      '#FCD34D'
};
// fallback colors if an unexpected topic appears
const FALLBACK_COLORS = ['#10B981','#A78BFA','#FCA5A5','#FCD34D','#93C5FD','#6EE7B7','#F9A8D4','#FDE68A','#86EFAC','#C4B5FD'];
function colorForTopic(name, i){
  const key = String(name||'').trim().toLowerCase();
  return TOPIC_COLORS[key] || FALLBACK_COLORS[i % FALLBACK_COLORS.length];
}

    // ======= JSONP helper (CORS-free) =======
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const sep = url.includes('?') ? '&' : '?';
        s.src = url + sep + 'jsonp=' + cb;
        s.onerror = ()=>reject(new Error('JSONP failed'));
        window[cb] = (data)=>{ resolve(data); cleanup(); };
        function cleanup(){ delete window[cb]; s.remove(); }
        document.body.appendChild(s);
      });
    }

    // ======= utilities =======
    const toET = (iso)=> {
      try{
        // Display local time; adjust if you prefer explicit ET via Intl with America/New_York
        const d = new Date(iso);
        return {
          date: d.toLocaleDateString('en-US',{ month:'short', day:'numeric', year:'numeric' }),
          time: d.toLocaleTimeString('en-US',{ hour:'numeric', minute:'2-digit' })
        };
      }catch(e){ return { date:'', time:'' }; }
    };

    function uniq(arr){ return [...new Set(arr)]; }

    // Extract Zoom Meeting ID from "Zoom URL: https://.../j/12345678901?..."
    function extractZoomIdFromCell(s){
      const m = String(s||'').match(/zoom\.us\/j\/(\d{9,})/i);
      return m ? m[1] : '';
    }

    // ======= Zoom enrichment (accept number or {minutes}) =======
    async function enrichWithZoom(items){
      const ids = uniq(items.map(r => extractZoomIdFromCell(r.zoom_url)).filter(Boolean));
      if (!ids.length) return items;

      // Batch lookup (server also writes minutes back to sheet)
      const res = await jsonp(`${GAS_URL}?action=zoomBatch&ids=${encodeURIComponent(ids.join(','))}`);
      const zoomMap = (res && res.map) || {};

      for (const row of items){
        const id = extractZoomIdFromCell(row.zoom_url);
        if (!id){ row.zoom_minutes = Number(row.zoom_minutes || 0); continue; }
        const v = zoomMap[id];
        const minutes = (typeof v === 'number') ? v : (v && v.minutes);
        row.zoom_minutes = Number(minutes || row.zoom_minutes || 0);
      }
      return items;
    }

    // ======= Metrics using real minutes only =======
    function computeMetrics(items){
      const cutoff = Date.now() - (DATE_WINDOW_DAYS*24*60*60*1000);
      const inRange = items.filter(r=>{
        // Use created_at if present, else include
        const t = r.created_at ? Date.parse(r.created_at) : null;
        return (t==null) || (t>=cutoff);
      });

      // status normalization:
      for (const r of inRange){
        const isNoShow = String(r.no_show||'').toLowerCase() === 'true' || String(r.no_show||'').toLowerCase() === 'yes';
        const isCanceled = !!r.canceled_at || String(r.status_raw||'').toLowerCase() === 'canceled';
        const zoomMin = Number(r.zoom_minutes||0);

        if (isNoShow){
          r._status = 'No-Show';
        } else if (isCanceled){
          r._status = 'Canceled';
        } else if (zoomMin > 0){
          r._status = 'Completed';
        } else {
          r._status = 'Scheduled';
        }
      }

      const totalMeetings = inRange.length;
      const completed = inRange.filter(r=>r._status==='Completed');
      const noShows = inRange.filter(r=>r._status==='No-Show').length;
      const canceled = inRange.filter(r=>r._status==='Canceled').length;
      const scheduled = inRange.filter(r=>r._status==='Scheduled').length;

      const totalMinutes = completed.reduce((s,r)=>s + Number(r.zoom_minutes||0), 0);
      const hours = totalMinutes/60;
      const avgMinutes = completed.length ? (totalMinutes/completed.length) : 0;

      return { inRange, totalMeetings, completed, totalMinutes, hours, avgMinutes, noShows, canceled, scheduled };
    }

    // ======= Rendering =======
    let lineChart, pieChart;

    function renderBase(items){
      const m = computeMetrics(items);

      // Header label
      document.getElementById('dateLabel').textContent = `ðŸ“… Last ${DATE_WINDOW_DAYS} days`;

      // Cards
      document.getElementById('statTotal').textContent = m.totalMeetings.toLocaleString();
      document.getElementById('statTotalSub').textContent = `${m.completed.length} completed â€¢ ${m.canceled} canceled â€¢ ${m.noShows} no-shows`;
      document.getElementById('statHours').textContent = m.hours.toFixed(1);
      document.getElementById('statAvg').textContent = `${m.avgMinutes.toFixed(0)}m`;
      const nsRate = m.totalMeetings ? (m.noShows/m.totalMeetings*100) : 0;
      document.getElementById('statNoShow').textContent = `${nsRate.toFixed(1)}%`;
      document.getElementById('statNoShowSub').textContent = `${m.noShows}/${m.totalMeetings} meetings`;

      // Line chart (by day, using Completed only)
      const byDay = new Map();
      for (const r of m.inRange){
        const d = r.start_time ? new Date(r.start_time) : (r.created_at ? new Date(r.created_at) : null);
        if(!d) continue;
        const key = d.toISOString().slice(0,10);
        const cnt = byDay.get(key) || 0;
        byDay.set(key, cnt + 1);
      }
      const labels = Array.from(byDay.keys()).sort();
      const data = labels.map(k => byDay.get(k));

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(document.getElementById('meetingsLine').getContext('2d'), {
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'Meetings',
            data,
            tension:.3,
            borderWidth:2,
            fill:true
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{ beginAtZero:true }
          }
        }
      });

      // Topics pie from question_2_topic of Completed only, with stable colors
const topics = new Map();
for (const r of m.completed){
  const k = String(r.question_2_topic || 'Unspecified').trim() || 'Unspecified';
  topics.set(k, (topics.get(k)||0) + 1);
}

// Prefer a canonical order so legend is stable, but keep any unseen labels
const CANON = ['Invoices','Forms','Other','Reporting','Inventory','Messaging/Client Communications','SOAP','Products','Reminders','Scheduling','Clients/Patients','Unspecified'];
const seen = new Set(topics.keys());
const topicLabels = CANON.filter(t => seen.has(t)).concat([...seen].filter(t => !CANON.includes(t)));

const topicData   = topicLabels.map(k => topics.get(k));
const topicColors = topicLabels.map((k,i) => colorForTopic(k,i));

if (pieChart) pieChart.destroy();
pieChart = new Chart(document.getElementById('topicsPie').getContext('2d'), {
  type:'doughnut',
  data:{
    labels: topicLabels,
    datasets:[{
      data: topicData,
      backgroundColor: topicColors,
      borderColor: '#ffffff',
      borderWidth: 1,
      hoverOffset: 4
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    cutout: '55%',
    plugins:{
      legend:{ position:'top', labels:{ usePointStyle:true, boxWidth:10 } }
    }
  }
});

      // Table
      renderTable(m.inRange);
      document.getElementById('tableHint').textContent = `${m.inRange.length} rows`;
    }

    function statusBadge(s){
      const map = {
        'Scheduled':'scheduled',
        'Completed':'completed',
        'Canceled':'canceled',
        'No-Show':'noshow'
      };
      const cls = map[s]||'scheduled';
      return `<span class="badge ${cls}">${s}</span>`;
    }

    function mkBtn(label, cls, attrs=''){
      return `<button class="btn ${cls}" ${attrs}>${label}</button>`;
    }

    function renderTable(rows){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      const sorted = [...rows].sort((a,b)=>{
        const ta = Date.parse(a.start_time||a.created_at||'')||0;
        const tb = Date.parse(b.start_time||b.created_at||'')||0;
        return tb - ta;
      });

      for (const r of sorted){
        const { date, time } = toET(r.start_time || r.created_at || '');
        const zoomMin = Number(r.zoom_minutes||0);
        const act = (r._status === 'No-Show')
          ? mkBtn('Unmark No-Show','btn-ghost',`data-act="unmark" data-uuid="${encodeURIComponent(r.event_uuid)}"`)
          : mkBtn('Mark No-Show','btn-ghost',`data-act="mark" data-uuid="${encodeURIComponent(r.event_uuid)}"`);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date || ''}</td>
          <td>${time || ''}</td>
          <td>${(r.attendee_name||'')}${r.attendee_email ? `<div class="muted">${r.attendee_email}</div>`:''}</td>
          <td>${r.question_2_topic || ''}</td>
          <td>${statusBadge(r._status)}</td>
          <td>${zoomMin ? `${zoomMin}m` : ''}</td>
          <td>${act}</td>
        `;
        tbody.appendChild(tr);
      }

      // wire actions
      tbody.querySelectorAll('button[data-uuid]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const uuid = decodeURIComponent(btn.getAttribute('data-uuid'));
          const isMark = btn.getAttribute('data-act') === 'mark';
          btn.classList.add('btn-loading');
          btn.textContent = isMark ? 'Markingâ€¦' : 'Unmarkingâ€¦';
          try{
            const action = isMark ? 'markNoShow' : 'unmarkNoShow';
            const res = await jsonp(`${GAS_URL}?action=${action}&uuid=${encodeURIComponent(uuid)}`);
            if (res && res.ok){
              // refetch and redraw so everything stays canonical
              await load(true);
            }else{
              alert('Failed to update no-show.');
            }
          }catch(e){
            console.error(e);
            alert('Failed to update no-show.');
          }finally{
            btn.classList.remove('btn-loading');
          }
        });
      });
    }

    // ======= Loader =======
    let cachedRows = null;

    async function load(force=false){
      if (cachedRows && !force){
        renderBase(cachedRows);
        return;
      }
      document.getElementById('meetingsHint').textContent = 'Loadingâ€¦';
      document.getElementById('tableHint').textContent = 'Loadingâ€¦';

      try{
        // 1) fetch raw rows from GAS
        const res = await jsonp(`${GAS_URL}?action=fetch&rangeDays=${DATE_WINDOW_DAYS}`);
        let items = Array.isArray(res && res.items) ? res.items : [];

        // 2) enrich with Zoom minutes (writes back to sheet on server as well)
        items = await enrichWithZoom(items);

        cachedRows = items;
        renderBase(items);
        document.getElementById('meetingsHint').textContent = '';
      }catch(e){
        console.error(e);
        document.getElementById('meetingsHint').textContent = 'Failed to load.';
        document.getElementById('tableHint').textContent = 'Failed to load data. Check your GAS URL.';
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', ()=> load(true));

    // go
    load();
  </script>
</body>
</html>
