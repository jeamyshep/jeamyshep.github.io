<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Meeting Analytics</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);margin:0;padding:20px;min-height:100vh}
  .wrap{max-width:1300px;margin:0 auto}
  .card{background:#fff; border-radius:18px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.08)}
  .grid{display:grid; gap:18px}
  .grid.stats{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .grid.charts{grid-template-columns:1fr 1fr}
  h1{margin:0 0 6px 0}
  .muted{color:#6b7280;font-size:14px}
  .kpi .label{color:#6b7280;font-size:13px;text-transform:uppercase; letter-spacing:.06em}
  .kpi .value{font-size:34px; font-weight:700; margin-top:8px}
  .badge{display:inline-block; padding:6px 12px; border-radius:999px; font-weight:600; font-size:13px}
  .status-Scheduled{background:#e5f1ff; color:#1d4ed8}
  .status-Completed{background:#dcfce7; color:#166534}
  .status-Canceled{background:#fee2e2; color:#7f1d1d}
  .status-No-Show{background:#fde68a; color:#7a3e00}
  table{width:100%; border-collapse:collapse}
  th,td{padding:14px 16px; border-bottom:1px solid #eef2f7; text-align:left}
  th{background:#f8fafc; font-size:13px; text-transform:uppercase; color:#667085; letter-spacing:.06em}
  .skel{background:linear-gradient(90deg,#eee,#f5f5f5,#eee); background-size:200% 100%; animation:sh 1.2s infinite}
  @keyframes sh {0%{background-position:0% 0}100%{background-position:-200% 0}}
  .btn{cursor:pointer; padding:6px 10px; border-radius:8px; border:none; background:#f1f5f9}
  .btn:hover{background:#e2e8f0}
  @media(max-width:950px){.grid.charts{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" style="margin-bottom:18px">
    <h1>ðŸ“Š Meeting Analytics</h1>
    <div class="muted">Past 30 & next 30 days</div>
    <div id="notice" class="muted" style="margin-top:10px; display:none"></div>
  </div>

  <div class="grid stats" style="margin-bottom:18px">
    <div class="card kpi"><div class="label">Total Meetings</div><div id="kpi-total" class="value skel">â€”</div></div>
    <div class="card kpi"><div class="label">Meeting Hours</div><div id="kpi-hours" class="value skel">â€”</div></div>
    <div class="card kpi"><div class="label">Avg Duration</div><div id="kpi-avg" class="value skel">â€”</div></div>
    <div class="card kpi"><div class="label">No-Show Rate</div><div id="kpi-noshow" class="value skel">â€”</div></div>
  </div>

  <div class="grid charts" style="margin-bottom:18px">
    <div class="card">
      <div style="margin-bottom:8px; font-weight:600">Meetings Over Time</div>
      <canvas id="lineChart" height="260"></canvas>
    </div>
    <div class="card">
      <div style="margin-bottom:8px; font-weight:600">Meeting Topic Distribution</div>
      <canvas id="topicChart" height="260"></canvas>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <div style="font-weight:600">Recent Meetings</div>
      <div id="zoomCount" class="muted">Zoom lookups: â€”</div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Time</th><th>Topic</th><th>Attendee</th><th>Duration</th><th>Status</th><th>Zoom</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/** SET THIS TO YOUR WEB APP URL **********************************************/
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyQWbwfMX9ABX7cLAmNOWKV8tkE9KCjJ0vDExD1j0fUSb4G-aoXvxEHr1D8P2d27WUpww/exec'; // e.g. https://script.google.com/macros/s/AKfycb.../exec

/** FAST LOAD: use cache first, then refresh in background *********************/
const CACHE_KEY = 'dash.events.v3';
const CACHE_MS  = 10 * 60 * 1000; // 10 minutes

const TOPIC_COLORS = {
  'SOAP':'#5B8FF9','Clients/Patients':'#5AD8A6','Scheduling':'#FF9D4D','Invoices':'#F6BD16',
  'Messaging/Client Communications':'#6F5EF9','Forms':'#6DC8EC','Reporting':'#9270CA',
  'Products':'#A0DC2C','Inventory':'#269A99','Bulk Edit':'#FF99C3','Reminders':'#FFD666','Other':'#5D7092','Unspecified':'#6675F5'
};
function colorForTopic(t){return TOPIC_COLORS[t] || '#6675F5'}

let line, donut;

(async function load(){
  try {
    // 1) cache-first paint
    const cached = getCache();
    if (cached) {
      renderAll(cached.items);
      pingAndRefresh(); // refresh in background
    } else {
      // 2) otherwise fetch now (JSONP so no CORS)
      const data = await jsonp(`${GAS_URL}?fn=events&rangeDays=60`);
      renderAll(data.items);
      setCache(data);
    }
  } catch (err) {
    showNotice('Error loading data. Check your Apps Script URL.', true);
    console.error(err);
  }
})();

function pingAndRefresh(){
  jsonp(`${GAS_URL}?fn=events&rangeDays=60`).then(data=>{
    setCache(data);
    renderAll(data.items); // swap in fresh
  }).catch(console.warn);
}

function getCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if (Date.now() - obj.ts > CACHE_MS) return null;
    return obj.data;
  }catch{return null}
}
function setCache(data){
  try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ ts:Date.now(), data })); }catch{}
}

/** JSONP helper ***************************************************************/
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = `gas_cb_${Math.random().toString(36).slice(2)}`;
    const s = document.createElement('script');
    const t = setTimeout(()=>{cleanup(); reject(new Error('JSONP timeout'))}, 120000);
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    function cleanup(){ clearTimeout(t); delete window[cb]; s.remove(); }
    s.onerror = ()=>{ cleanup(); reject(new Error('JSONP failed')); };
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}

/** Rendering ******************************************************************/
function renderAll(items){
  if (!Array.isArray(items)) items = [];
  // KPIs
  const mins = items.map(r=>durationMinutes(r)).filter(n=>n>0);
  const totalMeetings = items.length;
  const totalMinutes = mins.reduce((a,b)=>a+b,0);
  const avg = mins.length ? Math.round(totalMinutes/mins.length) : 0;
  const noShows = items.filter(r=>r.status==='No-Show').length;

  setText('#kpi-total', totalMeetings.toString());
  setText('#kpi-hours', (totalMinutes/60).toFixed(0));
  setText('#kpi-avg', `${avg}m`);
  setText('#kpi-noshow', totalMeetings? Math.round(noShows*100/totalMeetings)+'%':'0%');

  // Line chart (completed vs cancelled per day)
  const byDay = {};
  for(const r of items){
    const d = toLocalDateKey(r.start_time);
    if(!byDay[d]) byDay[d]={completed:0,canceled:0};
    if(r.status==='Canceled') byDay[d].canceled++;
    else if(r.status==='Completed') byDay[d].completed++;
  }
  const labels = Object.keys(byDay).sort();
  const completed = labels.map(d=>byDay[d].completed);
  const canceled  = labels.map(d=>byDay[d].canceled);
  drawLine(labels, completed, canceled);

  // Topic donut
  const topicCounts = {};
  for(const r of items){
    const k = (r.topic||'').trim() || 'Unspecified';
    topicCounts[k] = (topicCounts[k]||0)+1;
  }
  const topicLabels = Object.keys(topicCounts).sort();
  const topicVals   = topicLabels.map(k=>topicCounts[k]);
  const topicColors = topicLabels.map(colorForTopic);
  drawDonut(topicLabels, topicVals, topicColors);

  // Table
  renderRows(items);

  showNotice('Data loaded.');
}

function setText(sel, txt){
  const el=document.querySelector(sel);
  if(!el) return;
  el.classList.remove('skel');
  el.textContent = txt;
}

function drawLine(labels, completed, canceled){
  const ctx = document.getElementById('lineChart');
  if(line) line.destroy();
  line = new Chart(ctx,{type:'line',data:{
    labels,
    datasets:[
      {label:'Completed', data:completed, tension:.3, fill:false, borderWidth:2},
      {label:'Cancelled', data:canceled, tension:.3, fill:false, borderWidth:2}
    ]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'top'}},
      scales:{y:{beginAtZero:true}}}
  });
}

function drawDonut(labels, data, colors){
  const ctx = document.getElementById('topicChart');
  if(donut) donut.destroy();
  donut = new Chart(ctx,{type:'doughnut', data:{
    labels, datasets:[{data, backgroundColor:colors, borderWidth:0}]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'top'}}}
  });
}

function renderRows(items){
  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';
  // newest first, and only show ~100 for speed
  const list = [...items].sort((a,b)=>new Date(b.start_time)-new Date(a.start_time)).slice(0,100);

  let zoomResolvable = 0;
  for(const r of list){
    const tr = document.createElement('tr');

    const start = new Date(r.start_time);
    const end   = new Date(r.end_time);
    const mins  = durationMinutes(r);

    tr.innerHTML = `
      <td>${fmtDate(start)}</td>
      <td>${fmtTime(start)}</td>
      <td>${esc(r.topic||'Unspecified')}</td>
      <td>${esc(r.attendee_name||'')}</td>
      <td>${mins?mins+'m':'â€”'}</td>
      <td><span class="badge status-${r.status.replace(/\s/g,'-')}">${r.status}</span></td>
      <td>${(r.zoom_url||'').includes('zoom.us') ? '<a href="'+esc(r.zoom_url)+'" target="_blank">Open</a>' : 'â€”'}</td>
    `;

    // No-Show toggle (only for past meetings not canceled / not already no-show)
    if (r.status==='Completed') {
      const td = tr.children[5]; // status cell
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Mark No-Show';
      btn.style.marginLeft = '8px';
      btn.onclick = ()=>markNoShow(r.event_uuid, btn);
      td.appendChild(btn);
    }

    if ((r.zoom_url||'').includes('zoom.us')) zoomResolvable++;

    tbody.appendChild(tr);
  }
  document.getElementById('zoomCount').textContent = `Zoom lookups: ${zoomResolvable}/${list.length}`;
}

/** No-Show action *************************************************************/
async function markNoShow(id, btn){
  btn.disabled = true;
  btn.textContent = 'Savingâ€¦';
  try{
    const res = await jsonp(`${GAS_URL}?fn=mark_no_show&event_uuid=${encodeURIComponent(id)}`);
    if(res && res.ok){
      // hard refresh from server (and cache)
      const data = await jsonp(`${GAS_URL}?fn=events&rangeDays=60`);
      setCache(data);
      renderAll(data.items);
      showNotice('Marked as No-Show.');
    }else{
      showNotice('Could not mark No-Show.', true);
    }
  }catch(e){
    console.error(e);
    showNotice('Error marking No-Show.', true);
  }
}

/** Utils **********************************************************************/
function durationMinutes(r){
  const s = r.start_time ? new Date(r.start_time) : null;
  const e = r.end_time   ? new Date(r.end_time)   : null;
  if (!s || !e) return 0;
  const d = Math.round((e - s)/60000);
  return d>0 ? d : 0;
}
function toLocalDateKey(iso){
  if(!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString(undefined,{month:'short', day:'numeric'});
}
function fmtDate(d){ return d ? d.toLocaleDateString(undefined,{month:'short', day:'numeric', year:'numeric'}) : 'â€”'; }
function fmtTime(d){ return d ? d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) : 'â€”'; }
function esc(s){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function showNotice(msg, bad){
  const el = document.getElementById('notice');
  el.style.display = 'block';
  el.textContent = msg;
  el.style.color = bad ? '#b91c1c' : '#166534';
}
</script>
</body>
</html>
