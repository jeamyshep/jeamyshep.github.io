<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meeting Analytics Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica','Arial',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px
    }
    .dashboard{max-width:1400px;margin:0 auto;animation:fadeIn .5s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;margin-bottom:30px;box-shadow:0 10px 40px rgba(0,0,0,.1)}
    .header h1{color:#2d3748;font-size:32px;font-weight:700;margin-bottom:10px}
    .date-range{display:inline-flex;align-items:center;gap:10px;background:#f7fafc;padding:10px 20px;border-radius:10px;color:#718096;font-size:14px;margin-top:15px;transition:.3s;cursor:pointer}
    .date-range:hover{background:#edf2f7;transform:translateY(-2px)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:25px;box-shadow:0 10px 40px rgba(0,0,0,.1);transition:.3s cubic-bezier(.4,0,.2,1);cursor:pointer;position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea,#764ba2);transform:scaleX(0);transition:transform .3s}
    .stat-card:hover::before{transform:scaleX(1)}
    .stat-card:hover{transform:translateY(-5px);box-shadow:0 20px 60px rgba(0,0,0,.15)}
    .stat-label{color:#718096;font-size:14px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
    .stat-value{color:#2d3748;font-size:36px;font-weight:700;margin-bottom:10px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .stat-change{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;font-size:12px;font-weight:600}
    .stat-change.positive{background:#c6f6d5;color:#22543d}
    .stat-change.negative{background:#fed7d7;color:#742a2a}
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:20px;margin-bottom:30px}
    .chart-card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.1);transition:.3s}
    .chart-card:hover{transform:translateY(-5px);box-shadow:0 20px 60px rgba(0,0,0,.15)}
    .chart-title{color:#2d3748;font-size:18px;font-weight:600;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between}
    .chart-container{position:relative;height:300px}
    .table-card{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.1);margin-bottom:30px}
    .table-card h2{color:#2d3748;font-size:20px;font-weight:600;margin-bottom:20px}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:15px;background:#f7fafc;color:#4a5568;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid #e2e8f0}
    td{padding:15px;color:#2d3748;border-bottom:1px solid #e2e8f0;font-size:14px;transition:background .2s}
    tr:hover td{background:#f7fafc}
    .badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600}
    .badge.completed{background:#c6f6d5;color:#22543d}
    .badge.pending{background:#fef5e7;color:#7d6608}
    .badge.cancelled{background:#fed7d7;color:#742a2a}
    .spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(102,126,234,.3);border-radius:50%;border-top-color:#667eea;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:768px){.charts-grid{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <h1>ðŸ“Š Meeting Analytics</h1>
      <div class="date-range">ðŸ“… Last 30 Days</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Meetings</div>
        <div class="stat-value">â€”</div>
        <span class="stat-change positive" title="MoM">â†‘</span>
      </div>
      <div class="stat-card">
        <div class="stat-label">Meeting Hours</div>
        <div class="stat-value">â€”</div>
        <span class="stat-change positive" title="MoM">â†‘</span>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Duration</div>
        <div class="stat-value">â€”</div>
        <span class="stat-change negative" title="MoM">â†“</span>
      </div>
      <div class="stat-card">
        <div class="stat-label">No-show Rate</div>
        <div class="stat-value">â€”</div>
        <span class="stat-change positive" title="MoM">â†“</span>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3 class="chart-title">
          Meetings Over Time
          <span class="spinner" id="spinner1" style="display:none;"></span>
        </h3>
        <div class="chart-container">
          <canvas id="meetingsChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3 class="chart-title">
          Meeting Types Distribution
          <span class="spinner" id="spinner2" style="display:none;"></span>
        </h3>
        <div class="chart-container">
          <canvas id="typesChart"></canvas>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3 class="chart-title">Popular Time Slots</h3>
        <div class="chart-container">
          <canvas id="timeSlotsChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3 class="chart-title">Day of Week Distribution</h3>
        <div class="chart-container">
          <canvas id="dayChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-card">
      <h2>Recent Meetings</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Time</th><th>Type</th><th>Attendee</th><th>Duration</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
// ---------- helpers (safe + compile-clean) ----------
const lower = (v) => (v == null ? "" : String(v)).toLowerCase();

function getField(row, keys) {
  for (const k of keys) {
    const key = String(k).toLowerCase();
    if (row[key] !== undefined && row[key] !== null) {
      const v = row[key];
      if (Array.isArray(v) && v.length === 1) return v[0];
      return typeof v === "string" ? v : String(v);
    }
  }
  return "";
}

// Accept common key names
const START_KEYS   = ["start_time","start","start_at","starttime","scheduled_start_time"];
const END_KEYS     = ["end_time","end","end_at","endtime","scheduled_end_time"];
const TYPE_KEYS    = ["event_type","type","event","title","meeting_type"];
const NAME_KEYS    = ["attendee_name","name","guest","invitee_name","contact_name"];
const EMAIL_KEYS   = ["attendee_email","invitee_email","email","guest_email","contact_email"];
const STATUS_KEYS  = ["status","state","meeting_status"];
const CREATED_KEYS = ["created_at","created","booked_at","creation_time"];
const CANCELED_KEYS= ["canceled_at","cancelled_at","cancellation_time","cancel_time","canceled_time"];

// parseDate that returns a number (ms) or NaN
function parseDate(val) {
  if (val == null || val === "") return NaN;
  const n = Date.parse(val);
  if (!Number.isNaN(n)) return n;
  // Add any special parsing you need here; default:
  return NaN;
}

// ---------- build rows from normalized `items` ----------
function buildRows(items) {
  return items.map((r) => {
    const start_ms   = parseDate(getField(r, START_KEYS));
    const end_ms     = parseDate(getField(r, END_KEYS));
    const created_ms = parseDate(getField(r, CREATED_KEYS));
    const canceled_ms= parseDate(getField(r, CANCELED_KEYS));

    const type   = getField(r, TYPE_KEYS) || "Other";
    const name   = getField(r, NAME_KEYS) || "";
    const email  = getField(r, EMAIL_KEYS) || "";
    const status = lower(getField(r, STATUS_KEYS));

    return {
      start_ms,
      end_ms,
      created_ms,
      canceled_ms,
      event_type: type,
      attendee_name: name,
      attendee_email: email,
      status
    };
  });
}
</script>

<script>
(function () {
  // Run after DOM is ready
  const ready = (fn) =>
    (document.readyState !== "loading"
      ? fn()
      : document.addEventListener("DOMContentLoaded", fn));

  // Add a small banner
  function banner(msg, good=false) {
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.cssText = `margin:10px 0 0;color:${good?'#22543d':'#742a2a'};background:${good?'#c6f6d5':'#fed7d7'};border:1px solid ${good?'#9ae6b4':'#f5b7b1'};padding:8px 12px;border-radius:10px;font-weight:600`;
    (document.querySelector(".header") || document.body).appendChild(el);
  }

  ready(async function () {
    // 1) Is Chart.js loaded?
    if (!window.Chart) {
      console.error("Chart.js not loaded");
      banner("Chart.js failed to load â€” check the <script> CDN tag.", false);
      return;
    }

    // 2) Do canvases exist?
    const mc = document.getElementById("meetingsChart");
    if (!mc) {
      console.error("Canvas #meetingsChart not found");
      banner("Canvas #meetingsChart not found â€” is the HTML intact?", false);
      return;
    }

    // 3) Smoke test: draw a tiny bar, then destroy it
    try {
      const testCtx = mc.getContext("2d");
      const testChart = new Chart(testCtx, {
        type: "bar",
        data: { labels: ["OK"], datasets: [{ label: "Smoke", data: [1] }] },
        options: { animation: false, plugins: { legend: { display: false } } }
      });
      banner("Chart canvas OK â€” trying to load dataâ€¦", true);
      setTimeout(() => {
        try { Chart.getChart(testCtx.canvas)?.destroy(); } catch {}
      }, 300);
    } catch (e) {
      console.error("Smoke test failed:", e);
      banner("Could not draw to canvas â€” see console.", false);
      return;
    }

    // 4) Call your existing loader safely
    if (typeof loadData !== "function") {
      console.error("loadData() not found");
      banner("loadData() is not defined â€” is your main <script> included?", false);
      return;
    }

    try {
      await loadData();
      banner("Data loaded call completed.", true);
    } catch (e) {
      console.error("loadData error:", e);
      banner("loadData() threw an error â€” see console for details.", false);
    }
  });
})();
</script>


</body>
</html>
