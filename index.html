<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shepherd Connect Analytics Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2; --card:#fff; --text:#2d3748; --muted:#718096; --chip:#e6fffa;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;padding:20px;color:var(--text)}
    .container{max-width:1200px;margin:0 auto}
    .card{background:rgba(255,255,255,.96);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.12);padding:22px}
    header.card{margin-bottom:18px}
    h1{font-size:28px;margin-bottom:6px}
    .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;gap:16px}
    .grid.stats{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin:16px 0}
    .stat .label{color:var(--muted);text-transform:uppercase;font-weight:600;font-size:12px;margin-bottom:8px}
    .stat .val{font-size:34px;font-weight:800}
    .pill{display:inline-block;background:#c6f6d5;color:#22543d;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700}
    .warn{background:#fed7d7;color:#742a2a}
    .notice{background:#c6f6d5;color:#22543d}
    .section{margin-top:16px}
    .chart{height:320px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #e2e8f0;font-size:14px}
    th{background:#f7fafc;text-align:left;color:#4a5568;letter-spacing:.02em}
    .k{color:#4a5568;font-size:13px}
    .ok{background:#e6fffa;color:#035d56}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(102,126,234,.35);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .b-scheduled{background:#ebf8ff;color:#2b6cb0}
    .b-completed{background:#c6f6d5;color:#22543d}
    .b-cancelled{background:#fed7d7;color:#742a2a}
    .b-noshow{background:#ffe9b3;color:#6b4f00}
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <h1>ðŸ“Š Meeting Analytics</h1>
      <div class="sub">Past 30 &amp; next 30 days</div>
      <div id="alert" class="section"></div>
    </header>

    <section class="grid stats">
      <div class="card stat">
        <div class="label">Total Meetings</div>
        <div id="k_total" class="val">â€”</div>
      </div>
      <div class="card stat">
        <div class="label">Meeting Hours</div>
        <div id="k_hours" class="val">â€”</div>
      </div>
      <div class="card stat">
        <div class="label">Avg Duration</div>
        <div id="k_avg" class="val">â€”</div>
      </div>
      <div class="card stat">
        <div class="label">No-Show Rate</div>
        <div id="k_noshow" class="val">â€”</div>
      </div>
    </section>

    <section class="grid" style="grid-template-columns:1fr 1fr;">
      <div class="card">
        <div class="k">Meetings Over Time</div>
        <div class="chart"><canvas id="lineChart"></canvas></div>
      </div>
      <div class="card">
        <div class="k">Meeting Topic Distribution</div>
        <div class="chart"><canvas id="topicChart"></canvas></div>
      </div>
    </section>

    <section class="card section">
      <div class="k" style="margin-bottom:6px">Recent Meetings</div>
      <div class="k" id="zoomStatus"></div>
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Time</th><th>Topic</th><th>Attendee</th><th>Duration</th><th>Status</th><th>Zoom</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </div>

  <script>
    // 1) ADD YOUR APPS SCRIPT URL HERE (must end with /exec)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz7qVyJHTv6s1UP6-SgidFVbtSRxodLh1YRNwfYHjx0Q6Emd30O9S1dC_KLqLmYsz2Rxg/exec";

    // -------- utilities
    const fmtMin = m => `${m}m`;
    const parseISO = s => s ? new Date(s) : null;
    const df = (d, opts) => d ? d.toLocaleDateString(undefined, opts || {month:'short', day:'numeric', year:'numeric'}) : '';
    const tf = d => d ? d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) : '';

    async function fetchJSON(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    // Robust Zoom ID extractor for values like:  Zoom URL: 'https://.../j/1234567890?pwd=...'
    function zoomIdFromText(txt){
      if(!txt) return null;
      const s = String(txt).replace(/^Zoom URL:\s*/i,'').replace(/^['"]|['"]$/g,'').trim();
      const mNum = s.match(/zoom\.us\/(?:j|wc)\/(\d{7,})/i);
      if(mNum) return mNum[1];
      const mVanity = s.match(/zoom\.us\/my\/([a-z0-9._-]+)/i);
      if(mVanity) return `vanity:${mVanity[1]}`;
      return null;
    }

    // Simple safe getter (supports list of possible keys)
    function getField(row, candidates){
      for(const key of candidates){
        if(row[key] !== undefined && row[key] !== null && String(row[key]).trim() !== '') return row[key];
      }
      return '';
    }

    // Status builder (Scheduled | Completed | Canceled | No-Show)
    function computeStatus(row){
      const status = (String(getField(row,['status','meeting_status'])).toLowerCase());
      const canceledAt = getField(row,['canceled_at']);
      const noShow = /no[\s-]?show/i.test(getField(row,['no_show','notes','status_notes']));
      if(noShow) return 'No-Show';
      if(canceledAt || status==='canceled' || status==='cancelled') return 'Canceled';
      if(status==='completed' || status==='done') return 'Completed';
      return 'Scheduled';
    }

    function statusBadge(s){
      const map = {
        'Scheduled':'b-scheduled',
        'Completed':'b-completed',
        'Canceled':'b-cancelled',
        'No-Show':'b-noshow'
      };
      return `<span class="badge ${map[s]||'b-scheduled'}">${s}</span>`;
    }

    // -------- charts handles
    let lineChart, topicChart;

    function renderCharts(series, topicCounts){
      // line chart
      const labels = series.map(d=>d.label);
      const completed = series.map(d=>d.completed);
      const cancelled = series.map(d=>d.cancelled);

      const ctx1 = document.getElementById('lineChart').getContext('2d');
      if(lineChart) lineChart.destroy();
      lineChart = new Chart(ctx1,{
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'Completed', data:completed, tension:.35, fill:false},
            {label:'Cancelled', data:cancelled, tension:.35, fill:false}
          ]
        },
        options:{responsive:true, maintainAspectRatio:false}
      });

      // topic donut
      const tlabels = Object.keys(topicCounts);
      const tdata = tlabels.map(k=>topicCounts[k]);
      const colors = [
        '#3b82f6','#ef4444','#f59e0b','#10b981','#8b5cf6','#64748b','#06b6d4',
        '#84cc16','#f97316','#a855f7','#22c55e','#e11d48'
      ];
      const ctx2 = document.getElementById('topicChart').getContext('2d');
      if(topicChart) topicChart.destroy();
      topicChart = new Chart(ctx2,{
        type:'doughnut',
        data:{ labels:tlabels, datasets:[{ data:tdata, backgroundColor:tlabels.map((_,i)=>colors[i%colors.length]) }]},
        options:{responsive:true, maintainAspectRatio:false, cutout:'60%'}
      });
    }

    // -------- main
    (async function load(){
      const alert = document.getElementById('alert');
      const zoomStatus = document.getElementById('zoomStatus');
      try{
        if(!GAS_URL || GAS_URL.includes('https://script.google.com/macros/s/AKfycbz7qVyJHTv6s1UP6-SgidFVbtSRxodLh1YRNwfYHjx0Q6Emd30O9S1dC_KLqLmYsz2Rxg/exec')){
          alert.innerHTML = `<div class="badge warn">Add your Google Apps Script Web App URL (GAS_URL).</div>`;
          return;
        }

        alert.innerHTML = `<span class="badge notice">Loading dataâ€¦</span>`;
        const payload = await fetchJSON(GAS_URL);
        const items = (payload.items||[]);

        // normalize rows we need
        const now = new Date();
        const startBound = new Date(now); startBound.setDate(startBound.getDate()-30);
        const endBound = new Date(now);   endBound.setDate(endBound.getDate()+30);

        const rows = items.map(r=>{
          const start = parseISO(getField(r,['start_time','Start Date & Time','start','start_date_time']));
          const end   = parseISO(getField(r,['end_time','End Date & Time','end','end_date_time']));
          const topic = getField(r,['question_2_topic','Question 2 Response','Response 2','meeting_topic']) || 'Unspecified';
          const attendee = getField(r,['attendee_name','invitee_name','name']);
          const durMin = (()=> {
            const v = getField(r,['duration_min','duration','length_min']);
            const n = Number(v); return isFinite(n) && n>0 ? n : (start&&end ? Math.round((end-start)/60000) : 0);
          })();
          const status = computeStatus(r);

          // zoom id
          const ztxt = getField(r,['zoom_url','zoom_join_url','zoom_link','zoom_uri','location','notes','description']);
          const zoomId = zoomIdFromText(ztxt);

          return {raw:r,start,end,topic,attendee,durMin,status,zoomId};
        })
        // filter to Â±30d window if dates exist, else keep
        .filter(r=>!r.start || (r.start>=startBound && r.start<=endBound));

        // KPIs
        const total = rows.length;
        const totalMin = rows.reduce((a,b)=>a+b.durMin,0);
        const avg = total ? Math.round(totalMin/total) : 0;
        const noShows = rows.filter(r=>r.status==='No-Show').length;
        document.getElementById('k_total').textContent = total;
        document.getElementById('k_hours').textContent = (totalMin/60).toFixed(0);
        document.getElementById('k_avg').textContent = fmtMin(avg);
        document.getElementById('k_noshow').textContent = total ? `${Math.round((noShows/total)*100)}%` : '0%';

        // series for line chart (by day)
        const byDay = new Map();
        rows.forEach(r=>{
          const key = r.start ? r.start.toISOString().slice(0,10) : '';
          if(!key) return;
          if(!byDay.has(key)) byDay.set(key,{completed:0,cancelled:0});
          if(r.status==='Canceled') byDay.get(key).cancelled++;
          else if(r.status==='Completed' || r.status==='No-Show' || r.status==='Scheduled') byDay.get(key).completed++;
        });
        const series = Array.from(byDay.entries())
          .sort((a,b)=>a[0]<b[0]?-1:1)
          .map(([k,v])=>({label:new Date(k).toLocaleDateString(undefined,{month:'short',day:'numeric'}), ...v}));

        // topics
        const topicCounts = {};
        rows.forEach(r=>{ topicCounts[r.topic]=(topicCounts[r.topic]||0)+1; });

        renderCharts(series, topicCounts);

        // ---------- Zoom enrichment (CHUNKED) ----------
        zoomStatus.innerHTML = `<span class="spinner"></span> Resolving Zoom durationsâ€¦`;
        const zoomIdSet = new Set(rows.map(r=>r.zoomId).filter(Boolean));
        const ids = Array.from(zoomIdSet);
        const zoomMap = {};
        const CHUNK = 25;

        async function fetchZoomBatch(batch){
          const q = encodeURIComponent(batch.join(','));
          const url = `${GAS_URL}?zoom=1&ids=${q}`;
          const zres = await fetchJSON(url);
          (zres.meetings || []).forEach(m=>{
            if(m.id) zoomMap[m.id]=m;
            if(m.vanity) zoomMap[`vanity:${m.vanity}`]=m;
          });
        }
        for(let i=0;i<ids.length;i+=CHUNK){
          await fetchZoomBatch(ids.slice(i,i+CHUNK));
        }
        zoomStatus.textContent = `Zoom lookups: ${Object.keys(zoomMap).length}/${ids.length}`;

        // ---------- render table ----------
        const tbody = document.getElementById('rows');
        tbody.innerHTML = rows
          .sort((a,b)=>(b.start?.getTime()||0)-(a.start?.getTime()||0))
          .slice(0,100)
          .map(r=>{
            const z = r.zoomId ? (zoomMap[r.zoomId]||null) : null;
            const zoomCol = z ? `${(z.duration_min||'')}m` : (r.zoomId ? 'â€”' : '');
            const d = r.start ? df(r.start) : '';
            const t = r.start ? tf(r.start) : '';
            return `<tr>
              <td>${d}</td>
              <td>${t}</td>
              <td>${r.topic}</td>
              <td>${r.attendee||''}</td>
              <td>${fmtMin(r.durMin)}</td>
              <td>${statusBadge(r.status)}</td>
              <td>${zoomCol}</td>
            </tr>`;
          }).join('');

        alert.innerHTML = `<span class="badge ok">Data loaded.</span>`;
      }catch(err){
        console.error(err);
        document.getElementById('alert').innerHTML =
          `<span class="badge warn">Load error: ${String(err.message||err)}</span>`;
      }
    })();
  </script>
</body>
</html>
