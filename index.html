<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shepherd â€¢ Meeting Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>


  <style>
    :root {
      --bg1: #f6f8fc;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --brand1: #667eea;
      --brand2: #764ba2;
      --accent: #10b981;
      --danger: #ef4444;
      --warn: #f59e0b;
      --shadow: 0 10px 24px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(135deg, #eef2ff 0%, #fdf2f8 100%);
      color: var(--text);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .header {
      background: var(--panel); border-radius: 16px; padding: 20px;
      box-shadow: var(--shadow); margin-bottom: 16px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .title { font-size: 22px; font-weight: 800; letter-spacing: .2px; }
    .sub { color: var(--muted); font-size: 13px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card {
      background: var(--panel); border-radius: 16px; box-shadow: var(--shadow); padding: 16px;
    }
    .stat { grid-column: span 3; display: flex; flex-direction: column; gap: 6px; }
    .stat .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .5px; }
    .stat .value { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, var(--brand1), var(--brand2));
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }
    .stat .delta { font-size: 12px; font-weight: 700; display:inline-flex; align-items: center; gap:6px; padding:4px 8px; border-radius: 999px; }
    .delta.ok { background: #d1fae5; color: #065f46; }
    .delta.bad { background: #fee2e2; color: #991b1b; }

    .chart-card { grid-column: span 6; }
    .chart-title { display:flex; align-items:center; justify-content: space-between; margin-bottom: 8px; font-weight:700; }
    .chart-wrap { position: relative; height: 320px; }
    /* Prevent runaway canvas growth */
    canvas { max-height: 320px !important; }

    .table { grid-column: span 12; overflow: hidden; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #eef2f7; text-align: left; vertical-align: middle; }
    th { background:#f8fafc; color:#334155; font-weight:700; text-transform: uppercase; font-size: 12px; letter-spacing:.4px; }
    tr:hover td { background:#f9fafb; }
    .badge { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 999px; display:inline-block; }
    .b-scheduled { background:#e0e7ff; color:#3730a3; }
    .b-completed { background:#d1fae5; color:#065f46; }
    .b-canceled { background:#fee2e2; color:#991b1b; }
    .b-no-show { background:#fde68a; color:#92400e; }
    .btn {
      font-size: 12px; font-weight: 700; padding: 6px 10px; border-radius: 8px; border: 0; cursor: pointer;
      background: #f3f4f6; color: #111827;
    }
    .btn:hover { background:#e5e7eb; }
    .btn.primary { background: linear-gradient(135deg, var(--brand1), var(--brand2)); color:white; }
    .btn.warn { background: #fff7ed; color:#9a3412; border:1px solid #fdba74; }
    .pill { background:#f1f5f9; color:#0f172a; padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .muted { color: var(--muted); }

    @media (max-width: 900px) { .stat { grid-column: span 6; } .chart-card { grid-column: span 12; } }
    @media (max-width: 640px) { .stat { grid-column: span 12; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">ðŸ“Š Shepherd Meeting Analytics</div>
        <div class="sub"><span id="rangeLabel">Last 365 days</span> â€¢ <span id="loadStatus" class="muted">Loadingâ€¦</span></div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="refreshBtn">Refresh</button>
        <span class="pill" id="zoomHits">Zoom: 0/0</span>
        <span class="pill" id="rowCount">Loaded: 0</span>
      </div>
    </div>

    <div class="row" id="stats">
      <div class="card stat">
        <div class="label">Total Meetings (actual)</div>
        <div class="value" id="totalMeetings">â€”</div>
        <div class="delta ok" id="totalDelta">â€¢</div>
      </div>
      <div class="card stat">
        <div class="label">Meeting Hours (actual)</div>
        <div class="value" id="hours">â€”</div>
        <div class="delta ok" id="hoursDelta">â€¢</div>
      </div>
      <div class="card stat">
        <div class="label">Avg Duration (actual)</div>
        <div class="value" id="avg">â€”</div>
        <div class="delta bad" id="avgDelta">â€¢</div>
      </div>
      <div class="card stat">
        <div class="label">No-Show Rate</div>
        <div class="value" id="noshow">â€”</div>
        <div class="delta" id="noshowDelta">â€¢</div>
      </div>
    </div>

    <div class="row">
      <div class="card chart-card">
        <div class="chart-title">Meetings Over Time <span class="muted" id="s1"></span></div>
        <div class="chart-wrap"><canvas id="lineChart"></canvas></div>
      </div>
      <div class="card chart-card">
        <div class="chart-title">Meeting Topics</div>
        <div class="chart-wrap"><canvas id="topicChart"></canvas></div>
      </div>
    </div>

    <div class="row">
      <div class="card chart-card">
        <div class="chart-title">Popular Time Slots</div>
        <div class="chart-wrap"><canvas id="slotsChart"></canvas></div>
      </div>
      <div class="card chart-card">
        <div class="chart-title">Day of Week</div>
        <div class="chart-wrap"><canvas id="dowChart"></canvas></div>
      </div>
    </div>

    <div class="row">
      <div class="card table">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <strong>Recent Meetings</strong>
          <span class="muted" id="tableInfo"></span>
        </div>
        <div style="overflow:auto; max-height: 480px;">
          <table id="tbl">
            <thead>
              <tr>
                <th>Start</th>
                <th>Attendee</th>
                <th>Email</th>
                <th>Topic</th>
                <th>Status</th>
                <th>Zoom Minutes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======== CONFIG ========
    // ðŸ”´ Replace this with your Apps Script /exec URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyEtW4NavweNH70Kdd4ftwGHzNRFEwgNGF6783jhaFAUWeJ21NkhUSEJxNxHkdT7uzJ1w/exec";

    // ======== Utilities ========
    const ZOOM_ID_RE = /zoom\.us\/j\/(\d{8,})/i;
    const fmt = (n) => n.toLocaleString(undefined);
    const toDate = (iso) => iso ? new Date(iso) : null;
    const isPast = (iso, padMin = 5) => {
      const d = toDate(iso); if (!d) return false;
      return (Date.now() - d.getTime()) > padMin * 60 * 1000;
    };

    // JSONP helper (avoid CORS)
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = 'gas_cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const sep = url.includes('?') ? '&' : '?';
        s.src = `${url}${sep}callback=${cb}`;
        window[cb] = (data) => { resolve(data); cleanup(); };
        s.onerror = () => { reject(new Error('JSONP failed')); cleanup(); };
        function cleanup() { delete window[cb]; s.remove(); }
        document.body.appendChild(s);
      });
    }

    async function fetchJSONOrJSONP(url) {
      // Always JSONP to be safe with script.google.com
      return jsonp(url);
    }

    // Local cache for Zoom minutes to speed up reloads
    const ZCACHE_KEY = 'zoom_minutes_map_v1';
    const readZoomCache = () => {
      try { return JSON.parse(localStorage.getItem(ZCACHE_KEY) || '{}'); } catch { return {}; }
    };
    const writeZoomCache = (map) => { localStorage.setItem(ZCACHE_KEY, JSON.stringify(map||{})); };

    function extractZoomId(zoomCell) {
      if (!zoomCell) return null;
      const url = String(zoomCell).replace(/^Zoom URL:\s*/i, '').trim();
      const m = url.match(ZOOM_ID_RE);
      return (m && m[1]) ? m[1] : null;
    }

    function unique(arr) { return Array.from(new Set(arr)); }

    // Pleasant distinct color generator for topics
    function topicPalette(n) {
      // Pre-baked distinct palette; will cycle if > length
      const base = [
        '#6366F1','#F97316','#22C55E','#EF4444','#06B6D4','#A855F7',
        '#EAB308','#10B981','#F43F5E','#84CC16','#0EA5E9','#FB7185',
        '#14B8A6','#F59E0B','#8B5CF6','#60A5FA'
      ];
      return Array.from({length: n}, (_,i) => base[i % base.length]);
    }

    function statusBadge(s) {
      const v = (s||'').toLowerCase();
      if (v === 'completed') return '<span class="badge b-completed">Completed</span>';
      if (v === 'canceled' || v === 'cancelled') return '<span class="badge b-canceled">Canceled</span>';
      if (v === 'no-show' || v === 'no_show') return '<span class="badge b-no-show">No-Show</span>';
      return '<span class="badge b-scheduled">Scheduled</span>';
    }

    // ======== Charts ========
    let lineChart, topicChart, slotsChart, dowChart;

    function drawLineChart(points) {
      if (lineChart) lineChart.destroy();
      const ctx = document.getElementById('lineChart');
      lineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: points.map(p => p.label),
          datasets: [{
            label: 'Meetings',
            data: points.map(p => p.count),
            fill: true,
            tension: .35
          }]
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { precision:0 } }
          }
        }
      });
    }

    function drawTopicChart(topicCounts) {
      if (topicChart) topicChart.destroy();
      const labels = Object.keys(topicCounts);
      const vals = labels.map(k => topicCounts[k]);
      const colors = topicPalette(labels.length);
      const ctx = document.getElementById('topicChart');
      topicChart = new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets: [{ data: vals, backgroundColor: colors }] },
        options: { maintainAspectRatio: false, responsive: true }
      });
    }

    function drawSlotsChart(slotCounts) {
      if (slotsChart) slotsChart.destroy();
      const entries = Object.entries(slotCounts).sort((a,b)=> a[0].localeCompare(b[0]));
      const labels = entries.map(([h])=>h);
      const vals = entries.map(([_,v])=>v);
      const ctx = document.getElementById('slotsChart');
      slotsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label:'Meetings', data: vals, borderRadius: 8 }] },
        options: { maintainAspectRatio: false, responsive: true, scales: { y:{beginAtZero:true} } }
      });
    }

    function drawDowChart(dowCounts) {
      if (dowChart) dowChart.destroy();
      const order = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      const labels = order;
      const vals = labels.map(d => dowCounts[d] || 0);
      const ctx = document.getElementById('dowChart');
      dowChart = new Chart(ctx, {
        type: 'radar',
        data: { labels, datasets: [{ label:'Meetings', data: vals }] },
        options: { maintainAspectRatio: false, responsive: true }
      });
    }

    // ======== Rendering ========
    function renderStats(rows) {
      const total = rows.length;
      const totalMinutes = rows.reduce((s, r) => s + (Number(r.zoom_minutes)||0), 0);
      const hours = Math.round(totalMinutes / 60);
      const avg = total ? Math.round(totalMinutes / total) : 0;
      const nos = rows.filter(r => (r.status||'').toLowerCase()==='no-show' || (r.no_show||'').toString().toLowerCase()==='true').length;
      const nosRate = total ? Math.round(nos*100/total) : 0;

      document.getElementById('totalMeetings').textContent = fmt(total);
      document.getElementById('hours').textContent = fmt(hours);
      document.getElementById('avg').textContent = fmt(avg) + 'm';
      document.getElementById('noshow').textContent = fmt(nosRate) + '%';

      // Deltas are placeholders (you can wire historical compare here)
      document.getElementById('totalDelta').textContent = 'using real Zoom durations';
      document.getElementById('hoursDelta').textContent = `${fmt(totalMinutes)} minutes`;
      document.getElementById('avgDelta').textContent = 'actual';
      document.getElementById('noshowDelta').textContent = `${fmt(nos)} no-shows`;
    }

    function groupByDay(rows) {
      const m = new Map();
      for (const r of rows) {
        const d = new Date(r.start_time || r.created_at || Date.now());
        const label = d.toLocaleDateString(undefined, { month:'short', day:'numeric' });
        m.set(label, (m.get(label)||0)+1);
      }
      return Array.from(m.entries()).map(([label,count])=>({label,count}));
    }

    function countTopics(rows) {
      const obj = {};
      for (const r of rows) {
        const t = (r.question_2_topic || 'Other').trim();
        obj[t] = (obj[t]||0)+1;
      }
      return obj;
    }

    function countHourSlots(rows) {
      const obj = {};
      for (const r of rows) {
        const d = toDate(r.start_time || r.created_at);
        if (!d) continue;
        const label = d.toLocaleTimeString([], { hour: 'numeric' }); // e.g., "1 PM"
        obj[label] = (obj[label]||0)+1;
      }
      return obj;
    }

    function countDOW(rows) {
      const obj = {};
      for (const r of rows) {
        const d = toDate(r.start_time || r.created_at);
        if (!d) continue;
        const w = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
        obj[w] = (obj[w]||0)+1;
      }
      return obj;
    }

    function renderTable(rows) {
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      const sorted = rows.slice().sort((a,b)=> (b.start_time||'').localeCompare(a.start_time||''));
      const max = Math.min(100, sorted.length);
      for (let i=0;i<max;i++) {
        const r = sorted[i];
        const d = toDate(r.start_time || r.created_at);
        const when = d ? d.toLocaleString() : '';
        const topic = r.question_2_topic || 'â€”';
        const zm = Number(r.zoom_minutes)||0;
        const st = (r.status||'').toLowerCase();
        const badge = statusBadge(st);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${when}</td>
          <td>${r.attendee_name || 'â€”'}</td>
          <td>${r.attendee_email || 'â€”'}</td>
          <td>${topic}</td>
          <td>${badge}</td>
          <td>${zm ? (zm + 'm') : 'â€”'}</td>
          <td>
            <button class="btn warn" data-uuid="${r.event_uuid || ''}" data-status="${st}">Mark No-Show</button>
          </td>
        `;
        tb.appendChild(tr);
      }
      document.getElementById('tableInfo').textContent = `${fmt(sorted.length)} total â€¢ showing ${fmt(Math.min(100, sorted.length))}`;
      // Wire actions
      tb.querySelectorAll('button[data-uuid]').forEach(btn => {
        btn.addEventListener('click', () => markNoShow(btn.getAttribute('data-uuid')));
      });
    }

    async function markNoShow(uuid) {
      if (!uuid) return;
      try {
        const url = `${GAS_URL}?action=markNoShow&uuid=${encodeURIComponent(uuid)}`;
        const resp = await fetchJSONOrJSONP(url);
        if (resp && resp.ok) {
          alert('Marked as No-Show. Refreshingâ€¦');
          load(true);
        } else {
          alert('Failed to mark no-show.');
        }
      } catch (e) {
        alert('Failed to mark no-show.');
      }
    }

    // ======== Main Load ========
    async function load(force = false) {
      document.getElementById('loadStatus').textContent = 'Loadingâ€¦';
      try {
        const data = await fetchJSONOrJSONP(`${GAS_URL}?action=fetch&rangeDays=365`);
        let rows = (data && data.items) ? data.items : [];
        document.getElementById('rowCount').textContent = `Loaded: ${fmt(rows.length)}`;
        if (!rows.length) throw new Error('No rows returned');

        // Extract Zoom IDs
        const idsAll = unique(rows.map(r => extractZoomId(r.zoom_url || '')).filter(Boolean));
        // Use cache unless force reload
        let cache = force ? {} : readZoomCache();
        const toFetch = idsAll.filter(id => !(id in cache));
        let hitCount = 0;

        if (toFetch.length) {
          // Batch in chunks of 50
          for (let i=0; i<toFetch.length; i+=50) {
            const chunk = toFetch.slice(i, i+50);
            const res = await fetchJSONOrJSONP(`${GAS_URL}?action=zoomBatch&ids=${encodeURIComponent(chunk.join(','))}`);
            if (res && res.map) {
              Object.assign(cache, res.map);
              hitCount += Object.keys(res.map).length;
              writeZoomCache(cache);
            }
          }
        }
        // Merge minutes back into rows
        let applied = 0;
        for (const r of rows) {
          const id = extractZoomId(r.zoom_url || '');
          if (id && cache[id]) {
            r.zoom_minutes = Number(cache[id].minutes || 0);
            // Update status for past meetings when not canceled
            if (isPast(r.start_time || r.created_at) && (r.status || '').toLowerCase() !== 'canceled') {
              if (r.zoom_minutes > 0) r.status = 'completed';
              else if ((r.no_show||'').toString().toLowerCase() === 'true' || cache[id].no_show === true) r.status = 'no-show';
            }
            applied++;
          } else {
            r.zoom_minutes = Number(r.zoom_minutes || 0);
          }
        }

        document.getElementById('zoomHits').textContent = `Zoom: ${fmt(applied)}/${fmt(idsAll.length)}`;
        document.getElementById('s1').textContent = `${fmt(rows.length)} rows`;

        // Render
        renderStats(rows);
        drawLineChart(groupByDay(rows));
        drawTopicChart(countTopics(rows));
        drawSlotsChart(countHourSlots(rows));
        drawDowChart(countDOW(rows));
        renderTable(rows);

        document.getElementById('loadStatus').textContent = 'Ready';
      } catch (e) {
        console.error(e);
        document.getElementById('loadStatus').textContent = 'Failed';
        alert('Failed to load data. Check your GAS URL (must support JSONP).');
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', () => load(true));
    // Kick off
    load();
  </script>
</body>
</html>
