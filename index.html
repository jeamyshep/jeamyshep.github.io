<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shepherd Meeting Analytics</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:linear-gradient(160deg,#635bff 0%,#6f6cd6 100%) fixed;color:#1f2937}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .card{background:#f8fafc;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px}
    .h1{font-size:28px;font-weight:800;display:flex;align-items:center;gap:12px}
    .grid{display:grid;gap:16px}
    .kpis{grid-template-columns:repeat(4,1fr)}
    .kpi h4{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#6b7280;margin:0 0 6px}
    .kpi .v{font-size:34px;font-weight:800}
    .panel{grid-template-columns:1fr 1fr}
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px;border-top:1px solid #e5e7eb;font-size:14px}
    th{text-transform:uppercase;font-size:12px;letter-spacing:.06em;color:#6b7280;background:#f3f4f6}
    .badge{display:inline-block;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .ok{background:#dcfce7;color:#065f46}
    .warn{background:#fee2e2;color:#7f1d1d}
    .muted{color:#94a3b8}
    .btn{padding:6px 10px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    .btn:hover{background:#f9fafb}
    .tiny{font-size:12px;color:#6b7280}
    .okline{color:#10b981}
    .err{color:#b91c1c}
    canvas{max-width:100%;height:340px}
    .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:2px;background:#999}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:16px">
      <div class="h1">ðŸ“Š Shepherd Meeting Analytics</div>
      <div class="tiny" id="daterange">Last 30 days â€¢ <span id="loadStatus">Loadingâ€¦</span></div>
    </div>

    <div class="grid kpis">
      <div class="card kpi"><h4>Total Meetings</h4><div class="v" id="k_total">-</div><div class="tiny">Zoom lookups: <span id="zoomCounter">0/0</span></div></div>
      <div class="card kpi"><h4>Meeting Hours (Actual)</h4><div class="v" id="k_hours">0.0</div><div class="tiny">Uses Zoom when available</div></div>
      <div class="card kpi"><h4>Avg Duration (min)</h4><div class="v" id="k_avg">-</div></div>
      <div class="card kpi"><h4>No-Show Rate</h4><div class="v" id="k_ns">0%</div></div>
    </div>

    <div class="grid panel" style="margin-top:16px">
      <div class="card">
        <h3>Meetings Over Time</h3>
        <canvas id="line"></canvas>
      </div>
      <div class="card">
        <h3>Meeting Topics Breakdown</h3>
        <canvas id="topics"></canvas>
        <div class="legend" id="legend"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin:0 0 8px">Recent Meetings</h3>
      <div class="tiny">Zoom lookups: <span id="zoomCounter2">0/0</span></div>
      <table id="tbl">
        <thead>
          <tr>
            <th>Date</th><th>Time</th><th>Attendee</th><th>Email</th>
            <th>Topic</th><th>Status</th><th>Sched (min)</th><th>Zoom (min)</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // ===== EDIT ME: Your Apps Script Web App URL (ends with /exec)
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxcHqiEI0F90DCEYkp4IydvKGA8kKsAO_9rBrmTI2sOYoIlNR4ig9d1UGL23Hcfn5UN0Q/exec';

    // ===== Topic palette (stable colors)
    const TOPIC_COLORS = {
      'Invoices':'#3b82f6','Forms':'#f43f5e','Other':'#f59e0b','Reporting':'#facc15',
      'Inventory':'#2dd4bf','Messaging/Client Communications':'#8b5cf6','SOAP':'#cbd5e1',
      'Products':'#2563eb','Reminders':'#fb7185','Scheduling':'#f97316','Clients/Patients':'#fde047',
      'Unspecified':'#6366f1'
    };

    // ===== JSONP helper
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb='gas_cb_'+Math.random().toString(36).slice(2);
        const s=document.createElement('script');
        const sep=url.includes('?')?'&':'?';
        s.src=url+sep+'jsonp='+cb;
        s.onerror=()=>{reject(new Error('JSONP failed')); s.remove(); delete window[cb];};
        window[cb]=(data)=>{resolve(data); s.remove(); delete window[cb];};
        document.head.appendChild(s);
      });
    }

    // ===== State
    let ALL=[], ZDONE=0, ZTOTAL=0, lineChart, topicChart;

    function fmtDate(iso){ const d=new Date(iso); return d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}); }
    function fmtTime(iso){ const d=new Date(iso); return d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'}); }

    function computeKpis(rows){
      const done=rows.filter(r=>r.status==='completed' && !r.no_show);
      const total=rows.length;
      const schedMin=done.reduce((s,r)=>s+((new Date(r.end_time)-new Date(r.start_time))/60000),0);
      const actualMin=done.reduce((s,r)=>s+(r.zoom_minutes || ((new Date(r.end_time)-new Date(r.start_time))/60000)),0);
      const avg=done.length? Math.round((actualMin/done.length)*10)/10 : 0;
      const ns = rows.filter(r=>r.no_show==='true' || r.status==='no-show').length;
      document.getElementById('k_total').textContent=String(total);
      document.getElementById('k_hours').textContent=(actualMin/60).toFixed(1);
      document.getElementById('k_avg').textContent=String(avg);
      document.getElementById('k_ns').textContent=Math.round((ns/Math.max(total,1))*100)+'%';
    }

    function renderLine(rows){
      const byDay={};
      rows.forEach(r=>{
        const k=new Date(r.start_time).toISOString().slice(0,10);
        byDay[k]=(byDay[k]||0)+1;
      });
      const labels=Object.keys(byDay).sort();
      const data=labels.map(k=>byDay[k]);
      if (lineChart) lineChart.destroy();
      lineChart=new Chart(document.getElementById('line'),{
        type:'line',
        data:{labels,datasets:[{label:'Completed',data,borderWidth:2,pointRadius:2}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
      });
    }

    function renderTopics(rows){
      const counts={};
      rows.forEach(r=>{
        const t=r.question_2_topic || 'Unspecified';
        counts[t]=(counts[t]||0)+1;
      });
      const labels=Object.keys(counts);
      const data=labels.map(l=>counts[l]);
      const colors=labels.map(l=>TOPIC_COLORS[l]||'#94a3b8');
      if (topicChart) topicChart.destroy();
      topicChart=new Chart(document.getElementById('topics'),{
        type:'doughnut',
        data:{labels,datasets:[{data,backgroundColor:colors}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
      });
      // legend
      const lg=document.getElementById('legend'); lg.innerHTML='';
      labels.forEach((l,i)=>{
        const el=document.createElement('div'); el.className='chip';
        el.innerHTML=`<span class="dot" style="background:${colors[i]}"></span>${l}`;
        lg.appendChild(el);
      });
    }

    function badge(status,noShow){
      if (noShow==='true'||status==='no-show') return `<span class="badge warn">No-Show</span>`;
      if (status==='canceled') return `<span class="badge warn">Canceled</span>`;
      if (status==='completed') return `<span class="badge ok">Completed</span>`;
      return `<span class="badge" style="background:#e0e7ff;color:#1e40af">Scheduled</span>`;
    }

    function rowHtml(r){
      const schedMin=Math.round((new Date(r.end_time)-new Date(r.start_time))/60000);
      const z = (r.zoom_minutes!=null)? r.zoom_minutes : 'â€”';
      return `<tr data-id="${r.event_uuid}">
        <td>${fmtDate(r.start_time)}</td>
        <td>${fmtTime(r.start_time)}</td>
        <td>${r.attendee_name||'â€”'}</td>
        <td class="muted">${r.attendee_email||'â€”'}</td>
        <td>${r.question_2_topic||'Unspecified'}</td>
        <td>${badge(r.status,r.no_show)}</td>
        <td>${schedMin}</td>
        <td class="zcol">${z}</td>
        <td><button class="btn" onclick="markNoShow('${r.event_uuid}')">Mark No-Show</button></td>
      </tr>`;
    }

    function renderTable(rows){
      const tb=document.querySelector('#tbl tbody');
      tb.innerHTML = rows.map(rowHtml).join('');
    }

    async function markNoShow(id){
      try{
        await jsonp(`${GAS_URL}?action=markNoShow&event_uuid=${encodeURIComponent(id)}`);
        // reflect immediately
        const r = ALL.find(x=>x.event_uuid===id);
        if (r){ r.no_show='true'; r.status='no-show'; }
        renderTable(ALL);
        computeKpis(ALL);
      }catch(e){ alert('Mark no-show failed'); }
    }

    // ===== Zoom enrichment
    function needsZoom(r){
      if (!r.zoom_url) return false;
      const inPast = new Date(r.start_time) < new Date();
      const already = r.zoom_minutes != null && r.zoom_minutes !== '';
      return inPast && !already;
    }

    async function runZoomEnrichment(rows){
      // prepare pairs
      const pairs = rows.filter(needsZoom).map(r=>({event_uuid:r.event_uuid,zoom_url:r.zoom_url}));
      ZTOTAL = pairs.length; ZDONE = 0;
      updateZoomCounters();
      const batchSize = 20;
      for (let i=0;i<pairs.length;i+=batchSize){
        const slice=pairs.slice(i,i+batchSize);
        try{
          const payload = encodeURIComponent(JSON.stringify(slice));
          const res = await jsonp(`${GAS_URL}?action=zoomBatch&payload=${payload}`);
          if (res && Array.isArray(res.items)){
            res.items.forEach(it=>{
              const row = ALL.find(x=>x.event_uuid===it.event_uuid);
              if (row){
                row.zoom_minutes = it.zoom_minutes != null ? it.zoom_minutes : row.zoom_minutes;
                // auto no-show when Zoom says 0 min & meeting start already passed
                if ((it.no_show === true) || (it.zoom_minutes === 0 && new Date(row.start_time) < new Date())){
                  row.no_show = 'true';
                  row.status = (row.status==='scheduled') ? 'no-show' : row.status;
                }
              }
              ZDONE++;
            });
            updateZoomCounters();
            renderTable(ALL);
            computeKpis(ALL);
          }
        }catch(err){
          // keep going
        }
      }
    }

    function updateZoomCounters(){
      const text=`${ZDONE}/${ZTOTAL}`;
      document.getElementById('zoomCounter').textContent=text;
      document.getElementById('zoomCounter2').textContent=text;
    }

    // ===== Load
    (async function load(){
      document.getElementById('loadStatus').textContent='Loadingâ€¦';
      const rangeDays=365, nextDays=30;
      document.getElementById('daterange').firstChild && (document.getElementById('daterange').innerHTML=`Last ${rangeDays} days â€¢ <span id="loadStatus">Loadingâ€¦</span>`);
      const res = await jsonp(`${GAS_URL}?action=fetch&rangeDays=${rangeDays}&nextDays=${nextDays}`);
      ALL = res.items || [];
      computeKpis(ALL);
      renderLine(ALL);
      renderTopics(ALL);
      renderTable(ALL);
      document.getElementById('loadStatus').textContent='Loaded';
      runZoomEnrichment(ALL);   // do this after first paint (faster perceived load)
    })();
  </script>
</body>
</html>
