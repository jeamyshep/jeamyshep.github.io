<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shepherd â€¢ Meeting Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --card:#ffffffef; --muted:#718096; --ink:#2d3748;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh; padding:20px; color:var(--ink);
    }
    .dashboard{max-width:1400px;margin:0 auto;animation:fadeIn .4s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
    .header{background:var(--card);backdrop-filter:blur(10px);border-radius:20px;padding:24px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .header h1{font-size:28px}
    .date-range{display:inline-flex;gap:8px;background:#f7fafc;padding:8px 14px;border-radius:10px;color:#4a5568;font-size:14px;margin-top:10px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:16px;margin:18px 0}
    .stat-card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 8px 26px rgba(0,0,0,.08)}
    .stat-label{color:#718096;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px}
    .stat-value{font-size:30px;font-weight:700;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(480px,1fr));gap:16px;margin:16px 0}
    .chart-card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 8px 26px rgba(0,0,0,.08)}
    .chart-title{display:flex;justify-content:space-between;align-items:center;font-weight:600;margin-bottom:12px}
    .table-card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 8px 26px rgba(0,0,0,.08);margin-top:16px}
    table{width:100%;border-collapse:collapse}
    th{background:#f7fafc;text-align:left;padding:12px;border-bottom:2px solid #e2e8f0;font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:#4a5568}
    td{padding:12px;border-bottom:1px solid #edf2f7;font-size:14px}
    .badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600}
    .completed{background:#c6f6d5;color:#22543d}
    .scheduled{background:#ebf8ff;color:#2a4365}
    .cancelled{background:#fed7d7;color:#742a2a}
    .nosh{background:#ffeaa7;color:#7d6608}
    .btn{border:0;border-radius:10px;padding:6px 10px;font-size:12px;font-weight:600;cursor:pointer}
    .btn-ghost{background:#edf2f7;color:#2d3748}
    .btn-ghost:hover{filter:brightness(.98)}
    .spinner{display:inline-block;width:18px;height:18px;border:3px solid rgba(102,126,234,.25);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:768px){.charts-grid{grid-template-columns:1fr}}
    .muted{color:#718096}
  </style>
</head>
<body>
<div class="dashboard">
  <div class="header">
    <h1>ðŸ“Š Shepherd Meeting Analytics</h1>
    <div class="date-range">ðŸ“… Last <span id="rangeLabel">365</span> days â€¢ <span id="loadNote" class="muted">Chart canvas ready â€” loading dataâ€¦</span></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">Total Meetings</div><div id="kpiTotal" class="stat-value">â€”</div><div class="muted" id="kpiZoom">Zoom lookups: <span id="zoomProgress">0/0</span></div></div>
    <div class="stat-card"><div class="stat-label">Meeting Hours (Actual)</div><div id="kpiHours" class="stat-value">â€”</div><div class="muted">Uses Zoom when available</div></div>
    <div class="stat-card"><div class="stat-label">Avg Duration (min)</div><div id="kpiAvg" class="stat-value">â€”</div></div>
    <div class="stat-card"><div class="stat-label">No-Show Rate</div><div id="kpiNoShow" class="stat-value">â€”</div></div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">Meetings Over Time <span id="spinTime" class="spinner" style="display:none;"></span></div>
      <div style="position:relative;height:280px"><canvas id="meetingsChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Meeting Topics Breakdown <span id="spinTopic" class="spinner" style="display:none;"></span></div>
      <div style="position:relative;height:280px"><canvas id="topicChart"></canvas></div>
    </div>
  </div>

  <div class="table-card">
    <div class="chart-title">Recent Meetings <span id="spinTable" class="spinner" style="display:none;"></span></div>
    <table id="tbl">
      <thead>
      <tr>
        <th>Date</th><th>Time</th><th>Attendee</th><th>Email</th><th>Topic</th><th>Status</th><th>Sched (min)</th><th>Zoom (min)</th><th>Actions</th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
/** ====== SET THESE ====== **/
const GAS_URL  = 'https://script.google.com/macros/s/AKfycbzMd-BTIy7JlQJ4IlZtssSs9TPL0sSc0MiIQTkVn2eZQcw26AHKV6ruCAuS0t99dHqEqA/exec'; // e.g. https://script.google.com/macros/s/AKfycb.../exec
const ZOOM_URL = GAS_URL; // same URL, because action=zoom* is routed by doGet


/** ====== tiny JSONP helper (no CORS issues) ====== **/
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const t = setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));}, 15000);
    function cleanup(){clearTimeout(t); s.remove(); delete window[cb];}
    window[cb]=(data)=>{cleanup(); resolve(data);};
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror=()=>{cleanup(); reject(new Error('JSONP failed'));};
    document.body.appendChild(s);
  });
}

/** ====== utils ====== **/
const toISO = d => new Date(d).toISOString();
const fmtDate = iso => new Date(iso).toLocaleDateString([], {month:'short', day:'numeric'});
const fmtTime = iso => new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
const mins = (a,b)=> Math.max(0, Math.round((new Date(b)-new Date(a))/60000));

/** ====== stable color per topic ====== **/
const palette = [
  '#667eea','#764ba2','#f093fb','#96ceb4','#ffeaa7','#f6ad55','#63b3ed',
  '#fc8181','#68d391','#f6e05e','#b794f4','#f687b3','#81e6d9','#9ae6b4'
];
const topicColor = (topic)=>{
  if(!topic) return '#cbd5e0';
  let h=0; for(let i=0;i<topic.length;i++) h=(h*31 + topic.charCodeAt(i))>>>0;
  return palette[h % palette.length];
};

/** ====== global state ====== **/
let ITEMS = [];
let TOPIC_LIST = [];
let CHART_TIME, CHART_TOPIC;
let ZOOM_DONE=0, ZOOM_TOTAL=0;

/** ====== charts ====== **/
function buildCharts(){
  const ctx1=document.getElementById('meetingsChart');
  const ctx2=document.getElementById('topicChart');

  const byDay = {};
  ITEMS.forEach(it=>{
    const key = new Date(it.start_time).toISOString().slice(0,10);
    byDay[key]=(byDay[key]||0)+1;
  });
  const labels = Object.keys(byDay).sort();
  const series = labels.map(k=>byDay[k]);

  const topicCounts = {};
  ITEMS.forEach(it=>{
    const t = it.question_2_topic || 'Unspecified';
    topicCounts[t]=(topicCounts[t]||0)+1;
  });
  TOPIC_LIST = Object.keys(topicCounts).sort();
  const tData = TOPIC_LIST.map(t=>topicCounts[t]);
  const tColors = TOPIC_LIST.map(topicColor);

  if(CHART_TIME) CHART_TIME.destroy();
  CHART_TIME = new Chart(ctx1, {
    type:'line',
    data:{ labels, datasets:[{label:'Meetings', data:series, fill:true, tension:.35, borderColor:'#667eea', backgroundColor:'rgba(102,126,234,.12)'}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}
  });

  if(CHART_TOPIC) CHART_TOPIC.destroy();
  CHART_TOPIC = new Chart(ctx2, {
    type:'doughnut',
    data:{ labels:TOPIC_LIST, datasets:[{ data:tData, backgroundColor:tColors, borderWidth:0 }]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}
  });
}

/** ====== table + KPIs ====== **/
function renderTable(){
  const tb=document.getElementById('tbody');
  tb.innerHTML='';
  // newest first
  const rows = [...ITEMS].sort((a,b)=> new Date(b.start_time)-new Date(a.start_time)).slice(0,200);
  rows.forEach(it=>{
    const tr=document.createElement('tr');

    const scheduledMin = mins(it.start_time, it.end_time);
    const zoomMin = (typeof it.zoom_duration_min === 'number') ? it.zoom_duration_min : '';

    const status = deriveStatus(it);
    const badgeClass = status==='Completed' ? 'completed' :
                       status==='Canceled'  ? 'cancelled' :
                       status==='No-Show'   ? 'nosh' : 'scheduled';

    tr.innerHTML =
      `<td>${fmtDate(it.start_time)}</td>
       <td>${fmtTime(it.start_time)}</td>
       <td>${escapeHtml(it.attendee_name||'')}</td>
       <td>${escapeHtml(it.attendee_email||'')}</td>
       <td><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${topicColor(it.question_2_topic)};margin-right:6px"></span>${escapeHtml(it.question_2_topic||'')}</td>
       <td><span class="badge ${badgeClass}">${status}</span></td>
       <td class="muted" style="text-align:right">${scheduledMin||''}</td>
       <td style="text-align:right">${zoomMin!=='' ? zoomMin : '<span class="muted">â€”</span>'}</td>
       <td>
         <button class="btn btn-ghost" onclick="markNoShow('${encodeURIComponent(it.event_uuid)}')">Mark No-Show</button>
       </td>`;
    tb.appendChild(tr);
  });

  // KPIs
  document.getElementById('kpiTotal').textContent = ITEMS.length.toString();

  const completed = ITEMS.filter(it=> deriveStatus(it)==='Completed');
  const totalMins = completed.reduce((s,it)=>{
    const z = (typeof it.zoom_duration_min==='number') ? it.zoom_duration_min : mins(it.start_time, it.end_time);
    return s + z;
  },0);
  document.getElementById('kpiHours').textContent = (totalMins/60).toFixed(1);

  const avg = completed.length ? (totalMins / completed.length) : 0;
  document.getElementById('kpiAvg').textContent = Math.round(avg).toString();

  const nos = ITEMS.filter(it=> deriveStatus(it)==='No-Show').length;
  const rate = ITEMS.length ? Math.round(100*nos/ITEMS.length) : 0;
  document.getElementById('kpiNoShow').textContent = rate + '%';
}

function deriveStatus(it){
  // manual no-show wins
  const manual = (it.no_show||'').toString().toLowerCase().includes('marked as no show');
  const zoomFlag = (it.zoom_no_show === true);
  const canceled = !!(it.canceled_at) || (it.status==='canceled') || (it.status===true); // tolerate legacy
  const inPast = new Date(it.start_time) < new Date();

  if (manual || zoomFlag) return 'No-Show';
  if (canceled) return 'Canceled';
  if (inPast)  return 'Completed';
  return 'Scheduled';
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** ====== mark no-show (JSONP) ====== **/
async function markNoShow(eventUuidEncoded){
  if(!GAS_URL){alert('GAS_URL missing'); return;}
  const eventUuid = decodeURIComponent(eventUuidEncoded);
  try{
    const res = await jsonp(`${GAS_URL}?action=markNoShow&id=${encodeURIComponent(eventUuid)}`);
    if(!res || res.error){ alert(res && res.error ? res.error : 'Failed to mark no-show'); return; }
    // update local item, re-render fast
    const it = ITEMS.find(x=> x.event_uuid===eventUuid);
    if (it){ it.no_show = 'Marked as No Show'; }
    renderTable();
    buildCharts();
  }catch(e){
    alert('No-show update failed: '+ e.message);
  }
}

/** ====== Zoom enrichment (non-blocking) ====== **/
async function enrichWithZoom(items){
  if(!ZOOM_URL) return items;
  // Collect meeting IDs/URLs
  const ids = items.map(it => it.zoom_url || '').filter(Boolean);
  if(ids.length===0) return items;

  // Zoom batch in chunks to keep URL length sane
  const chunkSize = 25;
  ZOOM_TOTAL = ids.length; ZOOM_DONE = 0;
  updateZoomProgress();

  for (let i=0; i<ids.length; i+=chunkSize){
    const slice = ids.slice(i, i+chunkSize).map(encodeURIComponent).join(',');
    try{
      const out = await jsonp(`${ZOOM_URL}?action=zoomBatch&ids=${slice}`);
      if(out && out.items){
        // map by meeting_id or input
        out.items.forEach(z=>{
          // Match strategy: if the sheet stored full zoom_url text, prefer input matching;
          // otherwise try numeric meeting_id (string) containment in zoom_url.
          const target = items.find(it=>{
            if (z.input && it.zoom_url && it.zoom_url.includes(z.input)) return true;
            if (z.meeting_id && it.zoom_url && it.zoom_url.includes(z.meeting_id)) return true;
            return false;
          });
          if (target && z.ok){
            target.zoom_duration_min = z.zoom_duration_min;
            target.zoom_participants = z.zoom_participants;
            target.zoom_no_show      = z.zoom_no_show === true;
          }
        });
      }
    } catch(e){
      // ignore chunk failure; continue
    } finally {
      ZOOM_DONE += Math.min(chunkSize, ids.length - i);
      updateZoomProgress();
      renderTable(); // incremental refresh feels fast
    }
  }
  return items;
}
function updateZoomProgress(){
  document.getElementById('zoomProgress').textContent = `${ZOOM_DONE}/${ZOOM_TOTAL}`;
}

/** ====== load flow ====== **/
(async function load(){
  document.getElementById('spinTime').style.display='inline-block';
  document.getElementById('spinTopic').style.display='inline-block';
  document.getElementById('spinTable').style.display='inline-block';

  const days = 365;
  document.getElementById('rangeLabel').textContent = String(days);

  try{
    if(!GAS_URL){ throw new Error('Add your Google Apps Script Web App URL (GAS_URL).'); }
    // 1) fetch data fast
    const res = await jsonp(`${GAS_URL}?action=fetch&days=${days}`);
    if(res && res.items){ ITEMS = res.items; } else { ITEMS = []; }

    // Initial paint (fast)
    renderTable();
    buildCharts();

    // 2) non-blocking zoom enrichment
    await enrichWithZoom(ITEMS);

    // Final paint (with zoom data)
    renderTable();
    buildCharts();

    document.getElementById('loadNote').textContent = 'Loaded';
  }catch(e){
    document.getElementById('loadNote').textContent = 'Error loading data';
    console.error(e);
    alert(e.message || e);
  }finally{
    document.getElementById('spinTime').style.display='none';
    document.getElementById('spinTopic').style.display='none';
    document.getElementById('spinTable').style.display='none';
  }
})();
</script>
</body>
</html>
